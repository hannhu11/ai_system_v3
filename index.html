<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† AI Quiz System - H·ªá th·ªëng Tr·∫Øc nghi·ªám AI Th√¥ng minh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- Enhanced CSS for better UX -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Advanced Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js';
        
        const firebaseConfig = {
        apiKey: "AIzaSyCGAvJ8du5Xcp56ac4zPGLr2jcWPFr_qck",
        authDomain: "quiz-ai-system.firebaseapp.com",
        projectId: "quiz-ai-system",
        storageBucket: "quiz-ai-system.firebasestorage.app",
        messagingSenderId: "823165200254",
        appId: "1:823165200254:web:3e67eb0ccd1f46da5ab52f",
        measurementId: "G-16MBCN7DX6"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.storage = getStorage(window.firebaseApp);
    </script>
    
    <style>
        /* Enhanced CSS for better UX */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        .pulse-button { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .loading-spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3498db; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Enhanced buttons */
        .btn-primary { 
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { 
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            transform: scale(1.05);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6b7280, #4b5563);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background: linear-gradient(to right, #4b5563, #374151);
            transform: scale(1.05);
        }
        
        .btn-success {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: scale(1);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-success:hover {
            background: linear-gradient(to right, #059669, #047857);
            transform: scale(1.05);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-danger:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
            transform: scale(1.05);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f59e0b, #d97706);
            color: white;
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1);
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-warning:hover {
            background: linear-gradient(to right, #d97706, #b45309);
            transform: scale(1.05);
        }
        
        /* Enhanced cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #f3f4f6;
            overflow: hidden;
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(1.02);
        }
        
        .card-header {
            background: linear-gradient(to right, #eff6ff, #e0e7ff);
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-body { padding: 24px; }
        
        /* Enhanced form elements */
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
            resize: none;
        }
        .form-textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
            background: white;
        }
        .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        
        /* Progressive loading animations */
        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: #e5e7eb;
            border-radius: 4px;
        }
        .skeleton-text {
            height: 16px;
            background: #e5e7eb;
            border-radius: 4px;
            width: 75%;
            margin-bottom: 8px;
        }
        .skeleton-title {
            height: 24px;
            background: #e5e7eb;
            border-radius: 4px;
            width: 50%;
            margin-bottom: 16px;
        }
        
        /* Advanced modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 896px;
            max-height: 100vh;
            overflow-y: auto;
            transform: scale(1);
            transition: all 0.3s;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 16px;
            z-index: 50;
            transform: translateX(0);
            transition: all 0.3s;
        }
        .toast-success {
            border-color: #10b981;
            background: #ecfdf5;
        }
        .toast-error {
            border-color: #ef4444;
            background: #fef2f2;
        }
        .toast-warning {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        .toast-info {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        /* Enhanced progress bars */
        .progress-bar {
            width: 100%;
            background: #e5e7eb;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.5s ease-out;
        }
        
        /* Gamification elements */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 500;
        }
        .badge-gold {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .badge-silver {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .badge-bronze {
            background: #fed7aa;
            color: #c2410c;
            border: 1px solid #fb923c;
        }
        
        /* Chat/AI Assistant styles */
        .chat-container {
            max-height: 384px;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
        }
        .chat-message {
            padding: 12px;
            border-radius: 8px;
            max-width: 75%;
            margin-bottom: 12px;
        }
        .chat-user {
            background: #3b82f6;
            color: white;
            margin-left: auto;
        }
        .chat-ai {
            background: white;
            border: 1px solid #e5e7eb;
            margin-right: auto;
        }
        
        /* File upload area */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #3b82f6;
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        /* Enhanced animations */
        .bounce-in { animation: bounceIn 0.8s ease-out; }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Advanced table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .data-table th {
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
        }
        .data-table td {
            border-bottom: 1px solid #f3f4f6;
            padding: 12px 16px;
            color: #6b7280;
        }
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        /* Advanced image handling */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        @media (min-width: 768px) {
            .image-gallery { grid-template-columns: repeat(3, 1fr); }
        }
        @media (min-width: 1024px) {
            .image-gallery { grid-template-columns: repeat(4, 1fr); }
        }
        
        .image-thumbnail {
            width: 100%;
            height: 128px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .image-thumbnail:hover {
            opacity: 0.8;
        }
        
        /* Study mode enhancements */
        .flashcard {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            cursor: pointer;
            transform: scale(1);
            transition: all 0.3s;
        }
        .flashcard:hover {
            transform: scale(1.05);
        }
        .flashcard.flipped {
            background: #eff6ff;
            border: 2px solid #3b82f6;
        }
        
        /* Quiz adaptive features */
        .difficulty-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .difficulty-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
        }
        .difficulty-easy .difficulty-dot:nth-child(1) {
            background: #10b981;
        }
        .difficulty-medium .difficulty-dot:nth-child(1),
        .difficulty-medium .difficulty-dot:nth-child(2) {
            background: #f59e0b;
        }
        .difficulty-hard .difficulty-dot {
            background: #ef4444;
        }
        
        /* Performance metrics */
        .metric-card {
            background: linear-gradient(135deg, white, #f9fafb);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            border-left: 4px solid;
        }
        .metric-card.performance { border-left-color: #3b82f6; }
        .metric-card.accuracy { border-left-color: #10b981; }
        .metric-card.speed { border-left-color: #8b5cf6; }
        .metric-card.improvement { border-left-color: #f59e0b; }
        
        /* Tab buttons */
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            color: #6b7280;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        .tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Upload dropzone */
        .dropzone {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f9fafb;
        }
        .dropzone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .dropzone.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
            transform: scale(1.02);
        }
        
        /* AI processing animation */
        .ai-processing {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #3b82f6;
            font-weight: 500;
        }
        .ai-processing::before {
            content: 'ü§ñ';
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        /* Success notification */
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
        }
        .success-notification.show {
            transform: translateX(0);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .metric-card {
                padding: 16px;
            }
            .tab-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            .dropzone {
                padding: 24px;
            }
        }
        
        /* Responsive utilities */
        @media (max-width: 640px) {
            .mobile-hide { display: none; }
            .mobile-full { width: 100%; }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .dark-mode {
                background: #111827;
                color: white;
            }
            .dark-mode .card {
                background: #1f2937;
                border-color: #374151;
            }
            .dark-mode .form-input {
                background: #374151;
                border-color: #4b5563;
                color: white;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üß†</div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
                    AI Quiz System
                </h1>
                <p class="text-gray-600">H·ªá th·ªëng Tr·∫Øc nghi·ªám AI Th√¥ng minh</p>
                <p class="text-sm text-gray-500 mt-2">Phi√™n b·∫£n 3.0 - N√¢ng cao v·ªõi AI</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showAdminLogin()" class="btn-success w-full">
                    <i class="fas fa-cog mr-2"></i> Qu·∫£n tr·ªã vi√™n (Admin)
                </button>
                <button onclick="showUserLogin()" class="btn-primary w-full">
                    <i class="fas fa-user mr-2"></i> Ng∆∞·ªùi d√πng (User)
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <div class="text-xs text-gray-400 space-y-1">
                    <p>‚ú® AI t·ª± ƒë·ªông t·∫°o c√¢u h·ªèi t·ª´ h√¨nh ·∫£nh</p>
                    <p>ü§ñ Gi·∫£i th√≠ch th√¥ng minh b·∫±ng AI</p>
                    <p>ÔøΩ Th·ªëng k√™ h·ªçc t·∫≠p c√° nh√¢n h√≥a</p>
                    <p>üéØ L·ªô tr√¨nh h·ªçc t·∫≠p th√≠ch ·ª©ng</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">‚öôÔ∏è</div>
                <h2 class="text-3xl font-bold text-green-600 mb-2">Admin Portal</h2>
                <p class="text-gray-600">Truy c·∫≠p qu·∫£n tr·ªã h·ªá th·ªëng</p>
            </div>
            
            <form onsubmit="adminLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u Admin</label>
                    <input type="password" id="admin-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã" required
                           class="form-input">
                </div>
                <button type="submit" class="btn-success w-full">
                    <i class="fas fa-sign-in-alt mr-2"></i> ƒêƒÉng nh·∫≠p
                </button>
                <button type="button" onclick="backToMain()" class="btn-secondary w-full">
                    <i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                <h4 class="font-semibold text-green-800 mb-2">üîß T√≠nh nƒÉng Admin:</h4>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>‚Ä¢ T·∫°o c√¢u h·ªèi t·ª´ h√¨nh ·∫£nh b·∫±ng AI</li>
                    <li>‚Ä¢ Qu·∫£n l√Ω m√¥n h·ªçc v√† b·ªô ƒë·ªÅ</li>
                    <li>‚Ä¢ Th·ªëng k√™ chi ti·∫øt ng∆∞·ªùi d√πng</li>
                    <li>‚Ä¢ C·∫•u h√¨nh API keys</li>
                    <li>‚Ä¢ Xu·∫•t b√°o c√°o h·ªá th·ªëng</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- User Login -->
    <div id="user-login" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">üë§</div>
                <h2 class="text-3xl font-bold text-blue-600 mb-2">User Portal</h2>
                <p class="text-gray-600">B·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc t·∫≠p</p>
            </div>
            
            <form onsubmit="userLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n c·ªßa b·∫°n</label>
                    <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu" required
                           class="form-input">
                </div>
                <button type="submit" class="btn-primary w-full">
                    <i class="fas fa-play mr-2"></i> B·∫Øt ƒë·∫ßu h·ªçc t·∫≠p
                </button>
                <button type="button" onclick="backToMain()" class="btn-secondary w-full">
                    <i class="fas fa-arrow-left mr-2"></i> Quay l·∫°i
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">üéØ T√≠nh nƒÉng User:</h4>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>‚Ä¢ L√†m b√†i tr·∫Øc nghi·ªám v·ªõi AI h·ªó tr·ª£</li>
                    <li>‚Ä¢ Flashcards v√† Q&A Chatbot AI</li>
                    <li>‚Ä¢ L·ªô tr√¨nh h·ªçc t·∫≠p c√° nh√¢n h√≥a</li>
                    <li>‚Ä¢ Th·ªëng k√™ ti·∫øn ƒë·ªô chi ti·∫øt</li>
                    <li>‚Ä¢ Ch·∫ø ƒë·ªô thi ƒë·∫•u v√† x·∫øp h·∫°ng</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                            <i class="fas fa-cog mr-2"></i>Admin Dashboard
                        </h1>
                        <span class="badge badge-gold">
                            <i class="fas fa-crown mr-1"></i>Pro
                        </span>
                    </div>
                    <div class="flex space-x-4 items-center">
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Admin:</p>
                            <p id="admin-name" class="font-semibold text-green-600">Administrator</p>
                        </div>
                        <button onclick="exportSystemReport()" class="btn-warning">
                            <i class="fas fa-download mr-2"></i>Xu·∫•t b√°o c√°o
                        </button>
                        <button onclick="logout()" class="btn-danger">
                            <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Admin Content -->
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <!-- Enhanced Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-8">
                <div class="metric-card performance">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">T·ªïng c√¢u h·ªèi</p>
                            <p id="total-questions-stat" class="text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="text-4xl">üìö</div>
                    </div>
                    <div class="mt-2">
                        <div class="progress-bar">
                            <div id="questions-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metric-card accuracy">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">T·ªïng ng∆∞·ªùi d√πng</p>
                            <p id="total-users-stat" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="text-4xl">üë•</div>
                    </div>
                    <div class="mt-2 text-sm text-green-600">
                        <span id="active-users">0</span> ƒëang ho·∫°t ƒë·ªông
                    </div>
                </div>
                
                <div class="metric-card speed">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">L∆∞·ª£t l√†m b√†i</p>
                            <p id="total-attempts-stat" class="text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="text-4xl">üìù</div>
                    </div>
                    <div class="mt-2 text-sm text-purple-600">
                        +<span id="attempts-today">0</span> h√¥m nay
                    </div>
                </div>
                
                <div class="metric-card improvement">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ƒêi·ªÉm TB</p>
                            <p id="avg-score-stat" class="text-3xl font-bold text-orange-600">0%</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                    <div class="mt-2 text-sm text-orange-600">
                        <span id="score-trend">+0%</span> so v·ªõi tu·∫ßn tr∆∞·ªõc
                    </div>
                </div>
                
                <div class="metric-card performance">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">M√¥n h·ªçc</p>
                            <p id="total-subjects-stat" class="text-3xl font-bold text-indigo-600">0</p>
                        </div>
                        <div class="text-4xl">üìñ</div>
                    </div>
                    <div class="mt-2 text-sm text-indigo-600">
                        <span id="total-sets-stat">0</span> b·ªô ƒë·ªÅ
                    </div>
                </div>
                
                <div class="metric-card accuracy">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">AI Usage</p>
                            <p id="ai-usage-stat" class="text-3xl font-bold text-teal-600">0</p>
                        </div>
                        <div class="text-4xl">ü§ñ</div>
                    </div>
                    <div class="mt-2 text-sm text-teal-600">
                        <span id="ai-success-rate">100%</span> th√†nh c√¥ng
                    </div>
                </div>
            </div>

            <!-- Enhanced Tabs -->
            <div class="card">
                <div class="card-header">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showAdminTab('dashboard')" id="tab-dashboard" class="tab-btn active">
                            <i class="fas fa-chart-line mr-2"></i>Dashboard
                        </button>
                        <button onclick="showAdminTab('ai-tools')" id="tab-ai-tools" class="tab-btn">
                            <i class="fas fa-magic mr-2"></i>AI Tools
                        </button>
                        <button onclick="showAdminTab('subjects')" id="tab-subjects" class="tab-btn">
                            <i class="fas fa-book mr-2"></i>M√¥n h·ªçc
                        </button>
                        <button onclick="showAdminTab('questions')" id="tab-questions" class="tab-btn">
                            <i class="fas fa-question-circle mr-2"></i>C√¢u h·ªèi
                        </button>
                        <button onclick="showAdminTab('content')" id="tab-content" class="tab-btn">
                            <i class="fas fa-file-alt mr-2"></i>N·ªôi dung h·ªçc
                        </button>
                        <button onclick="showAdminTab('settings')" id="tab-settings" class="tab-btn">
                            <i class="fas fa-cog mr-2"></i>C√†i ƒë·∫∑t
                        </button>
                        <button onclick="showAdminTab('users')" id="tab-users" class="tab-btn">
                            <i class="fas fa-users mr-2"></i>Ng∆∞·ªùi d√πng
                        </button>
                        <button onclick="showAdminTab('analytics')" id="tab-analytics" class="tab-btn">
                            <i class="fas fa-chart-bar mr-2"></i>Ph√¢n t√≠ch
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    
                    <!-- Dashboard Tab -->
                    <div id="admin-tab-dashboard">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Quick Actions -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>Thao t√°c nhanh
                                </h3>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <button onclick="showAdminTab('ai-tools')" class="btn-primary text-center p-4">
                                        <i class="fas fa-magic block text-2xl mb-2"></i>
                                        <span>AI Tools</span>
                                    </button>
                                    <button onclick="quickAddQuestion()" class="btn-success text-center p-4">
                                        <i class="fas fa-plus block text-2xl mb-2"></i>
                                        <span>Th√™m c√¢u h·ªèi</span>
                                    </button>
                                    <button onclick="showAdminTab('content')" class="btn-warning text-center p-4">
                                        <i class="fas fa-upload block text-2xl mb-2"></i>
                                        <span>Upload n·ªôi dung</span>
                                    </button>
                                    <button onclick="showAdminTab('analytics')" class="btn-secondary text-center p-4">
                                        <i class="fas fa-chart-line block text-2xl mb-2"></i>
                                        <span>Ph√¢n t√≠ch</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-clock mr-2 text-blue-500"></i>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                                </h3>
                                <div id="recent-activity" class="space-y-3">
                                    <!-- Activity items will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Chart -->
                        <div class="mt-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-chart-area mr-2 text-purple-500"></i>Bi·ªÉu ƒë·ªì hi·ªáu su·∫•t
                            </h3>
                            <div class="bg-gray-50 rounded-lg p-6 h-64 flex items-center justify-center">
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-chart-line text-4xl mb-4"></i>
                                    <p>Bi·ªÉu ƒë·ªì hi·ªáu su·∫•t s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Tools Tab -->
                    <div id="admin-tab-ai-tools" class="hidden">
                        <div class="space-y-8">
                            <div class="text-center">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">
                                    <i class="fas fa-magic mr-2 text-purple-500"></i>AI Tools - C√¥ng c·ª• AI th√¥ng minh
                                </h3>
                                <p class="text-gray-600">S·ª≠ d·ª•ng s·ª©c m·∫°nh AI ƒë·ªÉ t·∫°o n·ªôi dung h·ªçc t·∫≠p t·ª± ƒë·ªông</p>
                            </div>
                            
                            <!-- Image to Questions AI -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-image mr-2 text-blue-500"></i>T·∫°o c√¢u h·ªèi t·ª´ h√¨nh ·∫£nh (AI)
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <div id="image-upload-dropzone" class="dropzone" onclick="document.getElementById('ai-image-input').click()">
                                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                                <p class="text-lg font-semibold text-gray-700">T·∫£i l√™n h√¨nh ·∫£nh c√¢u h·ªèi</p>
                                                <p class="text-sm text-gray-500 mt-2">AI s·∫Ω ƒë·ªçc v√† tr√≠ch xu·∫•t n·ªôi dung</p>
                                                <p class="text-xs text-gray-400 mt-1">H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 10MB/file)</p>
                                            </div>
                                            <input type="file" id="ai-image-input" accept="image/*" multiple class="hidden" onchange="handleAIImageUpload(this)">
                                            
                                            <div class="mt-4 space-y-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn m√¥n h·ªçc:</label>
                                                    <select id="ai-subject-select" class="form-select">
                                                        <option value="">Ch·ªçn m√¥n h·ªçc</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn b·ªô ƒë·ªÅ:</label>
                                                    <select id="ai-questionset-select" class="form-select">
                                                        <option value="">Ch·ªçn b·ªô ƒë·ªÅ</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h5 class="font-semibold text-gray-800 mb-3">Preview h√¨nh ·∫£nh:</h5>
                                            <div id="ai-image-preview" class="hidden">
                                                <div id="ai-images-container" class="space-y-3 max-h-96 overflow-y-auto">
                                                    <!-- Multiple images will be displayed here -->
                                                </div>
                                                <button onclick="processMultipleImagesWithAI()" class="btn-primary w-full mt-4">
                                                    <span class="ai-processing hidden">
                                                        <i class="fas fa-spinner fa-spin mr-2"></i>ƒêang ph√¢n t√≠ch b·∫±ng AI...
                                                    </span>
                                                    <span class="normal-text">
                                                        <i class="fas fa-magic mr-2"></i>T·∫°o c√¢u h·ªèi b·∫±ng AI
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- AI Processing Result -->
                                    <div id="ai-processing-result" class="hidden mt-6 p-6 bg-blue-50 rounded-lg border border-blue-200">
                                        <h5 class="font-semibold text-blue-800 mb-4">
                                            <i class="fas fa-robot mr-2"></i>K·∫øt qu·∫£ ph√¢n t√≠ch AI:
                                        </h5>
                                        <div id="ai-generated-content" class="space-y-4">
                                            <!-- AI generated content will appear here -->
                                        </div>
                                        <div class="mt-4 flex space-x-3">
                                            <button onclick="acceptAIQuestion()" class="btn-success">
                                                <i class="fas fa-check mr-2"></i>Ch·∫•p nh·∫≠n
                                            </button>
                                            <button onclick="regenerateAIQuestion()" class="btn-warning">
                                                <i class="fas fa-redo mr-2"></i>T·∫°o l·∫°i
                                            </button>
                                            <button onclick="cancelAIQuestion()" class="btn-danger">
                                                <i class="fas fa-times mr-2"></i>H·ªßy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Document to Content AI -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-file-alt mr-2 text-green-500"></i>T·∫°o n·ªôi dung h·ªçc t·ª´ t√†i li·ªáu (AI)
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <div id="document-upload-dropzone" class="dropzone" onclick="document.getElementById('ai-document-input').click()">
                                                <i class="fas fa-file-upload text-4xl text-gray-400 mb-4"></i>
                                                <p class="text-lg font-semibold text-gray-700">T·∫£i l√™n t√†i li·ªáu h·ªçc t·∫≠p</p>
                                                <p class="text-sm text-gray-500 mt-2">PDF, Word, PowerPoint, Text</p>
                                                <p class="text-xs text-gray-400 mt-1">T·ªëi ƒëa 50MB</p>
                                            </div>
                                            <input type="file" id="ai-document-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" class="hidden" onchange="handleDocumentUpload(this)">
                                            
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">T√πy ch·ªçn x·ª≠ l√Ω:</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="checkbox" id="generate-summary" checked class="mr-2">
                                                        <span>T·∫°o t√≥m t·∫Øt n·ªôi dung</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="checkbox" id="generate-questions" checked class="mr-2">
                                                        <span>T·ª± ƒë·ªông t·∫°o c√¢u h·ªèi</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="checkbox" id="generate-flashcards" checked class="mr-2">
                                                        <span>T·∫°o flashcards</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="document-processing-status" class="hidden">
                                            <h5 class="font-semibold text-gray-800 mb-3">Tr·∫°ng th√°i x·ª≠ l√Ω:</h5>
                                            <div class="space-y-3">
                                                <div class="flex items-center">
                                                    <div class="loading-spinner mr-3"></div>
                                                    <span>ƒêang ph√¢n t√≠ch t√†i li·ªáu...</span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div id="document-progress" class="progress-fill" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Batch Processing -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-layer-group mr-2 text-purple-500"></i>X·ª≠ l√Ω h√†ng lo·∫°t (Batch Processing)
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        <button onclick="batchProcessImages()" class="btn-primary p-4 text-center">
                                            <i class="fas fa-images block text-2xl mb-2"></i>
                                            <span>X·ª≠ l√Ω nhi·ªÅu h√¨nh ·∫£nh</span>
                                        </button>
                                        <button onclick="batchEditQuestions()" class="btn-warning p-4 text-center">
                                            <i class="fas fa-edit block text-2xl mb-2"></i>
                                            <span>Ch·ªânh s·ª≠a h√†ng lo·∫°t</span>
                                        </button>
                                        <button onclick="importFromTemplate()" class="btn-secondary p-4 text-center">
                                            <i class="fas fa-file-import block text-2xl mb-2"></i>
                                            <span>Import t·ª´ template</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Subjects Tab - Enhanced Version -->
                    <div id="admin-tab-subjects" class="hidden">
                        <!-- Add Subject Form -->
                        <div class="card mb-8">
                            <div class="card-header">
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-plus mr-2 text-green-500"></i>Th√™m m√¥n h·ªçc m·ªõi
                                </h3>
                            </div>
                            <div class="card-body">
                                <form onsubmit="addSubject(event)" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n m√¥n h·ªçc:</label>
                                            <input type="text" id="subject-name" required placeholder="V√≠ d·ª•: To√°n h·ªçc, V·∫≠t l√Ω, H√≥a h·ªçc..." 
                                                   class="form-input">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£:</label>
                                            <textarea id="subject-description" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ m√¥n h·ªçc..." 
                                                      class="form-textarea"></textarea>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">M√†u s·∫Øc ch·ªß ƒë·ªÅ:</label>
                                            <div class="flex space-x-2">
                                                <input type="color" id="subject-color" value="#3b82f6" class="w-12 h-12 rounded border">
                                                <input type="text" id="subject-color-text" value="#3b82f6" class="form-input flex-1">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Icon:</label>
                                            <select id="subject-icon" class="form-select">
                                                <option value="üìö">üìö S√°ch</option>
                                                <option value="üî¨">üî¨ Khoa h·ªçc</option>
                                                <option value="üìê">üìê To√°n h·ªçc</option>
                                                <option value="üåç">üåç ƒê·ªãa l√Ω</option>
                                                <option value="üìñ">üìñ VƒÉn h·ªçc</option>
                                                <option value="üéµ">üéµ √Çm nh·∫°c</option>
                                                <option value="üé®">üé® M·ªπ thu·∫≠t</option>
                                                <option value="‚öΩ">‚öΩ Th·ªÉ d·ª•c</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn-success w-full">
                                            <i class="fas fa-plus mr-2"></i>Th√™m m√¥n h·ªçc
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Subjects List -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-list mr-2 text-blue-500"></i>Danh s√°ch m√¥n h·ªçc
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="subjects-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Tab -->
                    <div id="admin-tab-questions" class="hidden">
                        
                        <!-- Quick Add Form -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <h3 class="text-lg font-bold text-green-800 mb-3">‚ö° Th√™m nhanh c√¢u h·ªèi</h3>
                            <form onsubmit="quickAddQuestion(event)" class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                    <select id="quick-subject" class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="T·ªïng h·ª£p">T·ªïng h·ª£p</option>
                                        <option value="To√°n h·ªçc">To√°n h·ªçc</option>
                                        <option value="V·∫≠t l√Ω">V·∫≠t l√Ω</option>
                                        <option value="H√≥a h·ªçc">H√≥a h·ªçc</option>
                                        <option value="Sinh h·ªçc">Sinh h·ªçc</option>
                                        <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
                                        <option value="ƒê·ªãa l√Ω">ƒê·ªãa l√Ω</option>
                                        <option value="Ti·∫øng Anh">Ti·∫øng Anh</option>
                                    </select>
                                    <select id="quick-difficulty" class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="easy">D·ªÖ</option>
                                        <option value="medium" selected>Trung b√¨nh</option>
                                        <option value="hard">Kh√≥</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-1 gap-3">
                                    <input type="text" id="quick-question" required placeholder="N·ªôi dung c√¢u h·ªèi" 
                                           class="w-full p-3 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input type="text" id="quick-answer-a" required placeholder="ƒê√°p √°n A" 
                                           class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <input type="text" id="quick-answer-b" required placeholder="ƒê√°p √°n B" 
                                           class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <input type="text" id="quick-answer-c" required placeholder="ƒê√°p √°n C" 
                                           class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <input type="text" id="quick-answer-d" required placeholder="ƒê√°p √°n D" 
                                           class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <select id="quick-correct-answer" required class="w-full p-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="">ƒê√°p √°n ƒë√∫ng?</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Th√™m
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Add Question Form -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Th√™m c√¢u h·ªèi m·ªõi</h3>
                            <form onsubmit="addQuestion(event)" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">M√¥n h·ªçc:</label>
                                        <select id="question-subject" required onchange="loadQuestionSets()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Ch·ªçn m√¥n h·ªçc</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">B·ªô ƒë·ªÅ:</label>
                                        <select id="question-set" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                            <option value="">Ch·ªçn b·ªô ƒë·ªÅ</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫£nh c√¢u h·ªèi:</label>
                                    <input type="file" id="question-image-input" accept="image/*" required 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    <div id="image-preview" class="mt-4 text-center hidden">
                                        <img id="preview-img" src="" alt="Preview" class="max-w-xs max-h-48 mx-auto rounded-lg shadow-md">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung c√¢u h·ªèi (t√πy ch·ªçn):</label>
                                    <textarea id="question-content-input" rows="3" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi n·∫øu c·∫ßn b·ªï sung..." 
                                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n A:</label>
                                        <input type="text" id="answer-a" required placeholder="Nh·∫≠p ƒë√°p √°n A" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n B:</label>
                                        <input type="text" id="answer-b" required placeholder="Nh·∫≠p ƒë√°p √°n B" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n C:</label>
                                        <input type="text" id="answer-c" required placeholder="Nh·∫≠p ƒë√°p √°n C" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n D:</label>
                                        <input type="text" id="answer-d" required placeholder="Nh·∫≠p ƒë√°p √°n D" 
                                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                                    <select id="correct-answer" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                        <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>

                                <button type="submit" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                    ‚ûï Th√™m c√¢u h·ªèi
                                </button>
                            </form>
                        </div>

                        <!-- Questions List -->
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Danh s√°ch c√¢u h·ªèi</h3>
                            
                            <!-- Filter controls -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">üîç L·ªçc c√¢u h·ªèi</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">M√¥n h·ªçc</label>
                                        <select id="filter-subject" onchange="loadFilterQuestionSets()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">B·ªô ƒë·ªÅ</label>
                                        <select id="filter-question-set" onchange="filterQuestions()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="resetQuestionFilter()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                            üîÑ Reset b·ªô l·ªçc
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="admin-questions-list" class="space-y-4">
                                <!-- Questions will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Content Tab -->
                    <div id="admin-tab-content" class="hidden">
                        <div class="space-y-8">
                            <div class="text-center">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">
                                    <i class="fas fa-file-alt mr-2 text-green-500"></i>Qu·∫£n l√Ω n·ªôi dung h·ªçc t·∫≠p
                                </h3>
                                <p class="text-gray-600">T·∫£i l√™n v√† qu·∫£n l√Ω t√†i li·ªáu h·ªçc t·∫≠p, t·∫°o b√†i h·ªçc t·ª± ƒë·ªông</p>
                            </div>
                            
                            <!-- Upload Learning Materials -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-upload mr-2 text-blue-500"></i>T·∫£i l√™n t√†i li·ªáu h·ªçc t·∫≠p
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <div id="learning-materials-dropzone" class="dropzone" onclick="document.getElementById('learning-materials-input').click()">
                                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                                <p class="text-lg font-semibold text-gray-700">T·∫£i l√™n t√†i li·ªáu</p>
                                                <p class="text-sm text-gray-500 mt-2">PDF, Word, PowerPoint, Text</p>
                                                <p class="text-xs text-gray-400 mt-1">H·ªó tr·ª£: PDF, DOC, DOCX, PPT, PPTX, TXT</p>
                                            </div>
                                            <input type="file" id="learning-materials-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt" multiple class="hidden" onchange="handleLearningMaterialsUpload(this)">
                                            
                                            <div class="mt-4 space-y-3">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn m√¥n h·ªçc:</label>
                                                    <select id="content-subject-select" class="form-select">
                                                        <option value="">Ch·ªçn m√¥n h·ªçc</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lo·∫°i n·ªôi dung:</label>
                                                    <select id="content-type-select" class="form-select">
                                                        <option value="lesson">B√†i h·ªçc</option>
                                                        <option value="reference">T√†i li·ªáu tham kh·∫£o</option>
                                                        <option value="exercise">B√†i t·∫≠p</option>
                                                        <option value="summary">T√≥m t·∫Øt</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div id="content-upload-preview" class="hidden">
                                            <h5 class="font-semibold text-gray-800 mb-3">T√†i li·ªáu ƒë√£ ch·ªçn:</h5>
                                            <div id="selected-files-list" class="space-y-2 mb-4">
                                                <!-- Selected files will appear here -->
                                            </div>
                                            <button onclick="processLearningMaterials()" class="btn-primary w-full">
                                                <i class="fas fa-magic mr-2"></i>X·ª≠ l√Ω b·∫±ng AI
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content Library -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-library mr-2 text-purple-500"></i>Th∆∞ vi·ªán n·ªôi dung
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div id="content-library" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                                        <!-- Content items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Settings Tab -->
                    <div id="admin-tab-settings" class="hidden">
                        <div class="space-y-8">
                            <!-- API Configuration -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-key mr-2 text-blue-500"></i>C·∫•u h√¨nh API
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 1 (Primary):</label>
                                            <div class="relative">
                                                <input type="password" id="admin-api-key-1" placeholder="Nh·∫≠p API Key ch√≠nh" 
                                                       class="form-input pr-10">
                                                <button type="button" onclick="toggleApiKeyVisibility('admin-api-key-1')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                                    <i class="fas fa-eye text-gray-400"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 2 (Backup):</label>
                                            <div class="relative">
                                                <input type="password" id="admin-api-key-2" placeholder="Nh·∫≠p API Key d·ª± ph√≤ng" 
                                                       class="form-input pr-10">
                                                <button type="button" onclick="toggleApiKeyVisibility('admin-api-key-2')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                                    <i class="fas fa-eye text-gray-400"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex space-x-3">
                                        <button onclick="saveAdminApiKeys()" class="btn-primary">
                                            <i class="fas fa-save mr-2"></i>L∆∞u API Keys
                                        </button>
                                        <button onclick="testApiKeys()" class="btn-secondary">
                                            <i class="fas fa-test-tube mr-2"></i>Test k·∫øt n·ªëi
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Configuration -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-cogs mr-2 text-green-500"></i>C·∫•u h√¨nh h·ªá th·ªëng
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Th·ªùi gian l√†m b√†i m·∫∑c ƒë·ªãnh (ph√∫t):</label>
                                                <input type="number" id="default-quiz-time" value="30" min="5" max="180" class="form-input">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë c√¢u h·ªèi t·ªëi ƒëa m·ªói b·ªô ƒë·ªÅ:</label>
                                                <input type="number" id="max-questions-per-set" value="50" min="1" max="200" class="form-input">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u Admin:</label>
                                                <div class="relative">
                                                    <input type="password" id="admin-password-setting" placeholder="Thay ƒë·ªïi m·∫≠t kh·∫©u admin" class="form-input pr-10">
                                                    <button type="button" onclick="toggleApiKeyVisibility('admin-password-setting')" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                                        <i class="fas fa-eye text-gray-400"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="enable-ai-explanations" checked class="mr-2">
                                                    <span>B·∫≠t gi·∫£i th√≠ch AI cho user</span>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="enable-user-registration" checked class="mr-2">
                                                    <span>Cho ph√©p user t·ª± ƒëƒÉng k√Ω</span>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="enable-offline-mode" class="mr-2">
                                                    <span>H·ªó tr·ª£ ch·∫ø ƒë·ªô offline</span>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="enable-gamification" checked class="mr-2">
                                                    <span>B·∫≠t t√≠nh nƒÉng gamification</span>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="flex items-center">
                                                    <input type="checkbox" id="enable-adaptive-learning" checked class="mr-2">
                                                    <span>H·ªçc t·∫≠p th√≠ch ·ª©ng (Adaptive Learning)</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex space-x-3">
                                        <button onclick="saveSystemSettings()" class="btn-success">
                                            <i class="fas fa-save mr-2"></i>L∆∞u c√†i ƒë·∫∑t
                                        </button>
                                        <button onclick="resetSystemSettings()" class="btn-warning">
                                            <i class="fas fa-undo mr-2"></i>Reset v·ªÅ m·∫∑c ƒë·ªãnh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Management -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-database mr-2 text-purple-500"></i>Qu·∫£n l√Ω d·ªØ li·ªáu
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                        <button onclick="exportAllData()" class="btn-primary p-4 text-center">
                                            <i class="fas fa-download block text-2xl mb-2"></i>
                                            <span>Xu·∫•t to√†n b·ªô d·ªØ li·ªáu</span>
                                        </button>
                                        <button onclick="importData()" class="btn-secondary p-4 text-center">
                                            <i class="fas fa-upload block text-2xl mb-2"></i>
                                            <span>Import d·ªØ li·ªáu</span>
                                        </button>
                                        <button onclick="clearAllData()" class="btn-danger p-4 text-center">
                                            <i class="fas fa-trash block text-2xl mb-2"></i>
                                            <span>X√≥a to√†n b·ªô d·ªØ li·ªáu</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Users Tab -->
                    <div id="admin-tab-users" class="hidden">
                        <div class="space-y-8">
                            <!-- User Overview -->
                            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div class="metric-card performance">
                                    <div class="text-center">
                                        <div class="text-3xl mb-2">üë•</div>
                                        <p id="users-total" class="text-2xl font-bold text-blue-600">0</p>
                                        <p class="text-sm text-gray-600">T·ªïng ng∆∞·ªùi d√πng</p>
                                    </div>
                                </div>
                                <div class="metric-card accuracy">
                                    <div class="text-center">
                                        <div class="text-3xl mb-2">üî•</div>
                                        <p id="users-active" class="text-2xl font-bold text-green-600">0</p>
                                        <p class="text-sm text-gray-600">ƒêang ho·∫°t ƒë·ªông</p>
                                    </div>
                                </div>
                                <div class="metric-card speed">
                                    <div class="text-center">
                                        <div class="text-3xl mb-2">‚≠ê</div>
                                        <p id="users-top-score" class="text-2xl font-bold text-purple-600">0</p>
                                        <p class="text-sm text-gray-600">ƒêi·ªÉm cao nh·∫•t</p>
                                    </div>
                                </div>
                                <div class="metric-card improvement">
                                    <div class="text-center">
                                        <div class="text-3xl mb-2">üìà</div>
                                        <p id="users-avg-improvement" class="text-2xl font-bold text-orange-600">+0%</p>
                                        <p class="text-sm text-gray-600">C·∫£i thi·ªán TB</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User Management -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="flex justify-between items-center">
                                        <h4 class="text-lg font-semibold">
                                            <i class="fas fa-users mr-2 text-blue-500"></i>Danh s√°ch ng∆∞·ªùi d√πng
                                        </h4>
                                        <div class="flex space-x-2">
                                            <button onclick="exportUserData()" class="btn-secondary">
                                                <i class="fas fa-download mr-2"></i>Xu·∫•t d·ªØ li·ªáu
                                            </button>
                                            <button onclick="sendBulkNotification()" class="btn-primary">
                                                <i class="fas fa-bullhorn mr-2"></i>G·ª≠i th√¥ng b√°o
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- User Filters -->
                                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">T√¨m ki·∫øm</label>
                                                <input type="text" id="user-search" placeholder="T√™n ng∆∞·ªùi d√πng..." class="form-input" onkeyup="filterUsers()">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Tr·∫°ng th√°i</label>
                                                <select id="user-status-filter" onchange="filterUsers()" class="form-select">
                                                    <option value="">T·∫•t c·∫£</option>
                                                    <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
                                                    <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">S·∫Øp x·∫øp theo</label>
                                                <select id="user-sort" onchange="filterUsers()" class="form-select">
                                                    <option value="newest">M·ªõi nh·∫•t</option>
                                                    <option value="oldest">C≈© nh·∫•t</option>
                                                    <option value="score-desc">ƒêi·ªÉm cao</option>
                                                    <option value="score-asc">ƒêi·ªÉm th·∫•p</option>
                                                    <option value="attempts">S·ªë l·∫ßn l√†m b√†i</option>
                                                </select>
                                            </div>
                                            <div class="flex items-end">
                                                <button onclick="resetUserFilter()" class="btn-secondary w-full">
                                                    <i class="fas fa-redo mr-2"></i>Reset
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Users Table -->
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Ng∆∞·ªùi d√πng</th>
                                                    <th>L·∫ßn cu·ªëi ho·∫°t ƒë·ªông</th>
                                                    <th>S·ªë l·∫ßn l√†m b√†i</th>
                                                    <th>ƒêi·ªÉm trung b√¨nh</th>
                                                    <th>ƒêi·ªÉm cao nh·∫•t</th>
                                                    <th>Th·ªùi gian TB</th>
                                                    <th>Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody id="users-table-body">
                                                <!-- User data will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="admin-tab-analytics" class="hidden">
                        <div class="space-y-8">
                            <div class="text-center">
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">
                                    <i class="fas fa-chart-line mr-2 text-purple-500"></i>Ph√¢n t√≠ch v√† b√°o c√°o chi ti·∫øt
                                </h3>
                                <p class="text-gray-600">Th·ªëng k√™ to√†n di·ªán v·ªÅ hi·ªáu su·∫•t h·ªá th·ªëng v√† ng∆∞·ªùi d√πng</p>
                            </div>
                            
                            <!-- Time Range Selector -->
                            <div class="card">
                                <div class="card-body">
                                    <div class="flex flex-wrap gap-4 items-center">
                                        <label class="text-sm font-medium text-gray-700">Th·ªùi gian:</label>
                                        <div class="flex space-x-2">
                                            <button onclick="setAnalyticsTimeRange('today')" class="btn-secondary">H√¥m nay</button>
                                            <button onclick="setAnalyticsTimeRange('week')" class="btn-secondary">Tu·∫ßn n√†y</button>
                                            <button onclick="setAnalyticsTimeRange('month')" class="btn-primary">Th√°ng n√†y</button>
                                            <button onclick="setAnalyticsTimeRange('year')" class="btn-secondary">NƒÉm n√†y</button>
                                        </div>
                                        <div class="flex space-x-2">
                                            <input type="date" id="analytics-start-date" class="form-input">
                                            <span class="text-gray-500">ƒë·∫øn</span>
                                            <input type="date" id="analytics-end-date" class="form-input">
                                            <button onclick="updateAnalytics()" class="btn-primary">
                                                <i class="fas fa-refresh mr-2"></i>C·∫≠p nh·∫≠t
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Performance Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- User Activity Chart -->
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="text-lg font-semibold">
                                            <i class="fas fa-chart-area mr-2 text-blue-500"></i>Ho·∫°t ƒë·ªông ng∆∞·ªùi d√πng
                                        </h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="user-activity-chart" class="h-64 flex items-center justify-center bg-gray-50 rounded">
                                            <div class="text-center text-gray-500">
                                                <i class="fas fa-chart-line text-4xl mb-4"></i>
                                                <p>Bi·ªÉu ƒë·ªì ho·∫°t ƒë·ªông ng∆∞·ªùi d√πng</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Score Distribution -->
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="text-lg font-semibold">
                                            <i class="fas fa-chart-pie mr-2 text-green-500"></i>Ph√¢n b·ªë ƒëi·ªÉm s·ªë
                                        </h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="score-distribution-chart" class="h-64 flex items-center justify-center bg-gray-50 rounded">
                                            <div class="text-center text-gray-500">
                                                <i class="fas fa-chart-pie text-4xl mb-4"></i>
                                                <p>Bi·ªÉu ƒë·ªì ph√¢n b·ªë ƒëi·ªÉm s·ªë</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Question Analysis -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-question-circle mr-2 text-purple-500"></i>Ph√¢n t√≠ch c√¢u h·ªèi
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üò∞</div>
                                            <p class="text-lg font-semibold text-red-600">C√¢u kh√≥ nh·∫•t</p>
                                            <p id="hardest-question" class="text-sm text-gray-600">ƒêang t·∫£i...</p>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üòä</div>
                                            <p class="text-lg font-semibold text-green-600">C√¢u d·ªÖ nh·∫•t</p>
                                            <p id="easiest-question" class="text-sm text-gray-600">ƒêang t·∫£i...</p>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-4xl mb-2">üîÑ</div>
                                            <p class="text-lg font-semibold text-blue-600">C·∫ßn c·∫£i thi·ªán</p>
                                            <p id="questions-need-improvement" class="text-sm text-gray-600">ƒêang t·∫£i...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Usage Statistics -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="text-lg font-semibold">
                                        <i class="fas fa-robot mr-2 text-teal-500"></i>Th·ªëng k√™ s·ª≠ d·ª•ng AI
                                    </h4>
                                </div>
                                <div class="card-body">
                                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-blue-600" id="ai-explanations-count">0</p>
                                            <p class="text-sm text-gray-600">L·∫ßn gi·∫£i th√≠ch AI</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-green-600" id="ai-questions-generated">0</p>
                                            <p class="text-sm text-gray-600">C√¢u h·ªèi t·ª± ƒë·ªông t·∫°o</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-purple-600" id="ai-success-rate-detailed">100%</p>
                                            <p class="text-sm text-gray-600">T·ª∑ l·ªá th√†nh c√¥ng</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-2xl font-bold text-orange-600" id="ai-cost-estimation">$0</p>
                                            <p class="text-sm text-gray-600">Chi ph√≠ ∆∞·ªõc t√≠nh</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Original Settings and Users tabs for compatibility -->
                    <div id="admin-tab-settings-old" class="hidden">
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h3 class="text-xl font-bold text-blue-800 mb-4">üîë C·∫•u h√¨nh API</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 1:</label>
                                    <input type="password" id="admin-api-key-1-old" placeholder="Nh·∫≠p API Key 1" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Gemini API Key 2 (Backup):</label>
                                    <input type="password" id="admin-api-key-2-old" placeholder="Nh·∫≠p API Key 2" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <button onclick="saveAdminApiKeys()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                üíæ L∆∞u API Keys
                            </button>
                        </div>
                    </div>

                    <div id="admin-tab-users-old" class="hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üë• Th·ªëng k√™ ng∆∞·ªùi d√πng</h3>
                        <div id="users-statistics" class="space-y-4">
                            <!-- User stats will be loaded here -->
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced User Dashboard -->
    <div id="user-dashboard" class="hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-lg sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            üß† AI Quiz System
                        </h1>
                        <span class="badge badge-silver">
                            <i class="fas fa-star mr-1"></i>Student
                        </span>
                    </div>
                    <div class="flex space-x-4 items-center">
                        <div class="text-right mobile-hide">
                            <p class="text-sm text-gray-600">H·ªçc vi√™n:</p>
                            <p id="current-user-name" class="font-semibold text-blue-600">Student</p>
                        </div>
                        <button onclick="showUserProfile()" class="btn-secondary">
                            <i class="fas fa-user mr-2"></i>H·ªì s∆°
                        </button>
                        <button onclick="logout()" class="btn-danger">
                            <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- User Content -->
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            
            <!-- Main Dashboard -->
            <div id="main-dashboard">
                <!-- Welcome Section -->
                <div class="card mb-8 bg-gradient-to-r from-blue-50 to-purple-50">
                    <div class="card-body">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">
                                    Ch√†o m·ª´ng tr·ªü l·∫°i, <span id="welcome-user-name" class="text-blue-600">Student</span>! üëã
                                </h2>
                                <p class="text-gray-600 mb-6">S·∫µn s√†ng cho h√†nh tr√¨nh h·ªçc t·∫≠p th√∫ v·ªã h√¥m nay?</p>
                                <div class="flex space-x-3">
                                    <button onclick="showQuizSelection()" class="btn-primary">
                                        <i class="fas fa-play mr-2"></i>B·∫Øt ƒë·∫ßu l√†m b√†i
                                    </button>
                                    <button onclick="showStudyMode()" class="btn-secondary">
                                        <i class="fas fa-book mr-2"></i>Ch·∫ø ƒë·ªô h·ªçc t·∫≠p
                                    </button>
                                    <button onclick="showAIChatbot()" class="btn-warning">
                                        <i class="fas fa-robot mr-2"></i>AI Assistant
                                    </button>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-8xl mb-4">üéØ</div>
                                <div id="daily-motivation" class="text-lg font-medium text-gray-700">
                                    "M·ªói c√¢u h·ªèi l√† m·ªôt c∆° h·ªôi ƒë·ªÉ ph√°t tri·ªÉn!"
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card performance">
                        <div class="text-center">
                            <div class="text-3xl mb-2">üìä</div>
                            <p id="total-attempts" class="text-2xl font-bold text-blue-600">0</p>
                            <p class="text-sm text-gray-600">L·∫ßn l√†m b√†i</p>
                        </div>
                    </div>
                    <div class="metric-card accuracy">
                        <div class="text-center">
                            <div class="text-3xl mb-2">üéØ</div>
                            <p id="average-score" class="text-2xl font-bold text-green-600">0%</p>
                            <p class="text-sm text-gray-600">ƒêi·ªÉm trung b√¨nh</p>
                        </div>
                    </div>
                    <div class="metric-card speed">
                        <div class="text-center">
                            <div class="text-3xl mb-2">‚ö°</div>
                            <p id="total-time" class="text-2xl font-bold text-purple-600">0:00</p>
                            <p class="text-sm text-gray-600">Th·ªùi gian TB</p>
                        </div>
                    </div>
                    <div class="metric-card improvement">
                        <div class="text-center">
                            <div class="text-3xl mb-2">üèÜ</div>
                            <p id="best-score" class="text-2xl font-bold text-orange-600">0%</p>
                            <p class="text-sm text-gray-600">ƒêi·ªÉm cao nh·∫•t</p>
                        </div>
                    </div>
                </div>

                <!-- Main Navigation -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Quick Access -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-rocket mr-2 text-blue-500"></i>Truy c·∫≠p nhanh
                            </h3>
                        </div>
                        <div class="card-body space-y-4">
                            <button onclick="continueLastQuiz()" class="btn-primary w-full">
                                <i class="fas fa-play mr-2"></i>Ti·∫øp t·ª•c b√†i g·∫ßn nh·∫•t
                            </button>
                            <button onclick="randomQuiz()" class="btn-secondary w-full">
                                <i class="fas fa-random mr-2"></i>B√†i thi ng·∫´u nhi√™n
                            </button>
                            <button onclick="showWeakTopics()" class="btn-warning w-full">
                                <i class="fas fa-target mr-2"></i>Luy·ªán ƒëi·ªÉm y·∫øu
                            </button>
                        </div>
                    </div>

                    <!-- AI Features -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-magic mr-2 text-purple-500"></i>T√≠nh nƒÉng AI
                            </h3>
                        </div>
                        <div class="card-body space-y-4">
                            <button onclick="generatePersonalizedQuiz()" class="btn-primary w-full">
                                <i class="fas fa-brain mr-2"></i>Quiz c√° nh√¢n h√≥a
                            </button>
                            <button onclick="showFlashcards()" class="btn-secondary w-full">
                                <i class="fas fa-cards-blank mr-2"></i>Flashcards AI
                            </button>
                            <button onclick="showStudyPath()" class="btn-warning w-full">
                                <i class="fas fa-route mr-2"></i>L·ªô tr√¨nh h·ªçc t·∫≠p
                            </button>
                        </div>
                    </div>

                    <!-- Progress Tracking -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-chart-line mr-2 text-green-500"></i>Ti·∫øn ƒë·ªô h·ªçc t·∫≠p
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">Ho√†n th√†nh h√¥m nay</span>
                                        <span id="daily-progress-text" class="text-sm font-medium">0/5</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="daily-progress" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-sm text-gray-600">Streak hi·ªán t·∫°i</span>
                                        <span id="current-streak" class="text-sm font-medium">0 ng√†y</span>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl">üî•</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card mt-8">
                    <div class="card-header">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-history mr-2 text-blue-500"></i>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                            </h3>
                            <button onclick="viewAllHistory()" class="btn-secondary">
                                <i class="fas fa-eye mr-2"></i>Xem t·∫•t c·∫£
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity-list" class="space-y-4">
                            <!-- Recent activities will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Selection -->
            <div id="quiz-selection" class="hidden">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-list mr-2 text-blue-500"></i>Ch·ªçn b·ªô ƒë·ªÅ thi
                    </h2>
                    <button onclick="backToMainDashboard()" class="btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
                    </button>
                </div>
                
                <!-- Subject Filter -->
                <div class="card mb-6">
                    <div class="card-body">
                        <div class="flex flex-wrap gap-4 items-center">
                            <span class="text-sm font-medium text-gray-700">L·ªçc theo m√¥n h·ªçc:</span>
                            <div id="subject-filter-buttons" class="flex flex-wrap gap-2">
                                <!-- Subject filter buttons will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="quiz-sets-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Quiz sets will be loaded here -->
                </div>
            </div>

            <!-- AI Chatbot Assistant -->
            <div id="ai-chatbot-section" class="hidden">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-robot mr-2 text-purple-500"></i>AI Assistant - Tr·ª£ l√Ω h·ªçc t·∫≠p th√¥ng minh
                    </h2>
                    <button onclick="backToMainDashboard()" class="btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-comments mr-2 text-blue-500"></i>H·ªèi ƒë√°p v·ªõi AI
                        </h3>
                        <div class="text-sm text-gray-600">ƒê·∫∑t b·∫•t k·ª≥ c√¢u h·ªèi n√†o v·ªÅ h·ªçc t·∫≠p, AI s·∫Ω h·ªó tr·ª£ b·∫°n!</div>
                    </div>
                    <div class="card-body">
                        <div class="chat-container" id="ai-chat-container">
                            <div class="chat-message chat-ai">
                                <div class="flex items-start space-x-2">
                                    <div class="text-2xl">ü§ñ</div>
                                    <div>
                                        <p>Xin ch√†o! T√¥i l√† AI Assistant. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                                        <ul class="mt-2 text-sm list-disc list-inside">
                                            <li>Gi·∫£i th√≠ch c√°c kh√°i ni·ªám h·ªçc t·∫≠p</li>
                                            <li>T·∫°o c√¢u h·ªèi luy·ªán t·∫≠p</li>
                                            <li>ƒê∆∞a ra l·ªùi khuy√™n h·ªçc t·∫≠p</li>
                                            <li>Ph√¢n t√≠ch ƒëi·ªÉm m·∫°nh/y·∫øu c·ªßa b·∫°n</li>
                                        </ul>
                                        <p class="mt-2">H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <input type="text" id="ai-chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." 
                                   class="form-input flex-1" onkeypress="handleChatEnter(event)">
                            <button onclick="sendAIMessage()" class="btn-primary">
                                <i class="fas fa-paper-plane mr-2"></i>G·ª≠i
                            </button>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="askQuickQuestion('Gi·∫£i th√≠ch kh√°i ni·ªám n√†y cho t√¥i')" class="btn-secondary text-sm">
                                üí° Gi·∫£i th√≠ch kh√°i ni·ªám
                            </button>
                            <button onclick="askQuickQuestion('T·∫°o c√¢u h·ªèi luy·ªán t·∫≠p cho t√¥i')" class="btn-secondary text-sm">
                                üìù T·∫°o c√¢u h·ªèi
                            </button>
                            <button onclick="askQuickQuestion('Ph√¢n t√≠ch ƒëi·ªÉm y·∫øu c·ªßa t√¥i')" class="btn-secondary text-sm">
                                üìä Ph√¢n t√≠ch ƒëi·ªÉm y·∫øu
                            </button>
                            <button onclick="askQuickQuestion('ƒê∆∞a ra l·ªùi khuy√™n h·ªçc t·∫≠p')" class="btn-secondary text-sm">
                                üéØ L·ªùi khuy√™n h·ªçc t·∫≠p
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Mode -->
            <div id="study-mode-section" class="hidden">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-book mr-2 text-green-500"></i>Ch·∫ø ƒë·ªô h·ªçc t·∫≠p
                    </h2>
                    <button onclick="backToMainDashboard()" class="btn-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Flashcards -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-cards-blank mr-2 text-blue-500"></i>Flashcards AI
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="flashcard-container" class="text-center">
                                <div class="flashcard" id="current-flashcard" onclick="flipFlashcard()">
                                    <div id="flashcard-front" class="text-lg font-semibold text-gray-800">
                                        Click ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc flashcards
                                    </div>
                                    <div id="flashcard-back" class="hidden text-gray-600">
                                        <!-- Flashcard back content -->
                                    </div>
                                </div>
                                <div class="mt-6 flex justify-center space-x-4">
                                    <button onclick="previousFlashcard()" class="btn-secondary">
                                        <i class="fas fa-arrow-left mr-2"></i>Tr∆∞·ªõc
                                    </button>
                                    <button onclick="nextFlashcard()" class="btn-primary">
                                        <i class="fas fa-arrow-right mr-2"></i>Ti·∫øp
                                    </button>
                                </div>
                                <div class="mt-4">
                                    <button onclick="generateNewFlashcards()" class="btn-warning">
                                        <i class="fas fa-magic mr-2"></i>T·∫°o flashcards m·ªõi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Study Path -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-route mr-2 text-purple-500"></i>L·ªô tr√¨nh h·ªçc t·∫≠p c√° nh√¢n
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="study-path-container">
                                <div class="space-y-4">
                                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="text-2xl mr-3">‚úÖ</div>
                                            <div>
                                                <p class="font-semibold text-green-800">Ho√†n th√†nh</p>
                                                <p class="text-sm text-green-600">B√†i h·ªçc c∆° b·∫£n</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="text-2xl mr-3">üìö</div>
                                            <div>
                                                <p class="font-semibold text-blue-800">ƒêang h·ªçc</p>
                                                <p class="text-sm text-blue-600">B√†i h·ªçc n√¢ng cao</p>
                                                <div class="mt-2 progress-bar">
                                                    <div class="progress-fill" style="width: 60%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg opacity-60">
                                        <div class="flex items-center">
                                            <div class="text-2xl mr-3">üîí</div>
                                            <div>
                                                <p class="font-semibold text-gray-800">S·∫Øp m·ªü kh√≥a</p>
                                                <p class="text-sm text-gray-600">B√†i h·ªçc chuy√™n s√¢u</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button onclick="generatePersonalizedPath()" class="btn-primary w-full">
                                        <i class="fas fa-magic mr-2"></i>T·∫°o l·ªô tr√¨nh c√° nh√¢n h√≥a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Quiz Interface -->
            <div id="quiz-interface" class="hidden">
                <div class="mb-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800" id="quiz-title">Quiz Title</h2>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-clock mr-1"></i>
                                <span id="quiz-timer">--:--</span>
                            </div>
                            <button onclick="exitQuiz()" class="btn-danger">
                                <i class="fas fa-times mr-2"></i>Tho√°t
                            </button>
                        </div>
                    </div>
                    <!-- Enhanced Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>C√¢u <span id="current-question-num">1</span> / <span id="total-questions">10</span></span>
                            <span>ƒêi·ªÉm: <span id="current-score">0</span></span>
                        </div>
                        <div class="progress-bar">
                            <div id="quiz-progress" class="progress-fill transition-all duration-300" style="width: 10%"></div>
                        </div>
                        <!-- Difficulty Indicator -->
                        <div class="mt-2 flex items-center space-x-2">
                            <span class="text-sm text-gray-600">ƒê·ªô kh√≥:</span>
                            <div id="difficulty-indicator" class="flex space-x-1">
                                <div class="w-3 h-3 rounded-full bg-green-400"></div>
                                <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                                <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                            </div>
                            <span id="difficulty-text" class="text-sm font-medium text-green-600">D·ªÖ</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <!-- Question Container -->
                        <div id="question-container">
                            <div class="mb-6">
                                <h3 id="question-text" class="text-lg font-semibold text-gray-800 mb-4">
                                    Loading question...
                                </h3>
                                <div id="question-image-container" class="hidden mb-4">
                                    <img id="question-image" src="" alt="Question Image" class="max-w-full h-auto rounded-lg">
                                </div>
                            </div>
                            
                            <!-- Answer Options -->
                            <div id="answer-options" class="space-y-3">
                                <!-- Options will be loaded here -->
                            </div>
                            
                            <!-- AI Hint -->
                            <div id="ai-hint-container" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-2"></i>
                                    <div>
                                        <p class="font-semibold text-blue-800">G·ª£i √Ω t·ª´ AI:</p>
                                        <p id="ai-hint-text" class="text-blue-700 mt-1"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Answer Explanation -->
                            <div id="explanation-container" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-green-500 mt-1 mr-2"></i>
                                    <div>
                                        <p class="font-semibold text-green-800">Gi·∫£i th√≠ch:</p>
                                        <p id="explanation-text" class="text-green-700 mt-1"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiz Controls -->
                        <div class="mt-8 flex justify-between items-center">
                            <div class="flex space-x-3">
                                <button id="hint-btn" onclick="getAIHint()" class="btn-secondary">
                                    <i class="fas fa-lightbulb mr-2"></i>G·ª£i √Ω
                                </button>
                                <button id="skip-btn" onclick="skipQuestion()" class="btn-warning">
                                    <i class="fas fa-forward mr-2"></i>B·ªè qua
                                </button>
                            </div>
                            <div class="flex space-x-3">
                                <button id="prev-btn" onclick="previousQuestion()" class="btn-secondary" disabled>
                                    <i class="fas fa-arrow-left mr-2"></i>Tr∆∞·ªõc
                                </button>
                                <button id="next-btn" onclick="nextQuestion()" class="btn-primary" disabled>
                                    Ti·∫øp <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                                <button id="submit-btn" onclick="submitQuiz()" class="btn-success hidden">
                                    <i class="fas fa-check mr-2"></i>N·ªôp b√†i
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results & Analytics -->
            <div id="results-section" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-trophy mr-3 text-yellow-500"></i>K·∫øt qu·∫£ Quiz
                    </h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Score Card -->
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-4xl font-bold text-blue-600 mb-2" id="final-score">0/10</div>
                            <p class="text-gray-600">ƒêi·ªÉm s·ªë</p>
                            <div class="mt-4">
                                <div class="text-2xl mb-2" id="score-emoji">üéâ</div>
                                <p id="score-message" class="text-sm text-gray-700">Xu·∫•t s·∫Øc!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Card -->
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-4xl font-bold text-green-600 mb-2" id="time-taken">0:00</div>
                            <p class="text-gray-600">Th·ªùi gian</p>
                            <div class="mt-4">
                                <div class="text-2xl mb-2">‚è±Ô∏è</div>
                                <p id="time-performance" class="text-sm text-gray-700">T·ªët</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Accuracy Card -->
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="accuracy-rate">0%</div>
                            <p class="text-gray-600">ƒê·ªô ch√≠nh x√°c</p>
                            <div class="mt-4">
                                <div class="text-2xl mb-2">üéØ</div>
                                <p id="accuracy-message" class="text-sm text-gray-700">Tuy·ªát v·ªùi!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Analysis -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-robot mr-2 text-blue-500"></i>Ph√¢n t√≠ch AI
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="ai-analysis-content">
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Review -->
                <div class="card mb-8">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold">
                            <i class="fas fa-list mr-2 text-green-500"></i>Xem l·∫°i c√¢u tr·∫£ l·ªùi
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="question-review" class="space-y-4">
                            <!-- Question reviews will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="text-center space-x-4">
                    <button onclick="retakeQuiz()" class="btn-warning">
                        <i class="fas fa-redo mr-2"></i>L√†m l·∫°i
                    </button>
                    <button onclick="backToMainDashboard()" class="btn-primary">
                        <i class="fas fa-home mr-2"></i>V·ªÅ trang ch√≠nh
                    </button>
                    <button onclick="shareResults()" class="btn-secondary">
                        <i class="fas fa-share mr-2"></i>Chia s·∫ª k·∫øt qu·∫£
                    </button>
                </div>
            </div>

            <!-- Quiz Content -->
            <div id="user-quiz-content" class="hidden bg-white rounded-xl shadow-2xl p-6 md:p-8">
                <!-- Quiz Header -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Tr·∫Øc nghi·ªám AI</h2>
                    <div class="flex justify-center items-center space-x-4 text-gray-600">
                        <span>C√¢u <span id="user-current-question">1</span>/<span id="user-total-questions">0</span></span>
                        <span>ƒêi·ªÉm: <span id="user-score" class="font-bold text-green-600">0</span></span>
                        <span>Th·ªùi gian: <span id="quiz-timer" class="font-bold text-blue-600">00:00</span></span>
                    </div>
                </div>

                <!-- Question Content -->
                <div id="user-question-content" class="fade-in">
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <img id="user-question-image" src="" alt="C√¢u h·ªèi" onclick="openImageModal()" 
                                 class="max-w-full h-auto rounded-lg shadow-md mx-auto max-h-96 object-contain cursor-pointer hover:opacity-90 transition-opacity">
                            <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                üîç Ph√≥ng to
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 id="user-question-text" class="text-xl font-semibold text-gray-800 text-center mb-6"></h3>
                    </div>

                    <!-- Answer Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <button id="user-option-A" onclick="userSelectAnswer('A')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">A. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-B" onclick="userSelectAnswer('B')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">B. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-C" onclick="userSelectAnswer('C')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">C. </span><span class="answer-text"></span>
                        </button>
                        <button id="user-option-D" onclick="userSelectAnswer('D')" class="user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                            <span class="font-bold text-blue-600">D. </span><span class="answer-text"></span>
                        </button>
                    </div>

                    <!-- AI Explanation -->
                    <div id="user-ai-explanation" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded">
                        <div class="flex items-center mb-2">
                            <span class="text-red-600 font-bold">ü§ñ AI Gi·∫£i th√≠ch:</span>
                            <div id="user-loading-ai" class="loading-spinner ml-4 hidden"></div>
                        </div>
                        <p id="user-explanation-text" class="text-gray-700"></p>
                    </div>

                    <!-- Next Button -->
                    <div class="text-center">
                        <button id="user-next-btn" onclick="userNextQuestion()" class="hidden px-8 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors pulse-button">
                            C√¢u ti·∫øp theo ‚Üí
                        </button>
                        <button onclick="backToQuizSelection()" class="ml-4 px-6 py-2 text-gray-500 hover:text-gray-700 border border-gray-300 rounded-lg">
                            ‚Üê Ch·ªçn l·∫°i ƒë·ªÅ
                        </button>
                    </div>
                </div>

                <!-- Quiz Complete -->
                <div id="user-quiz-complete" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-3xl font-bold text-green-600 mb-4">Ho√†n th√†nh!</h3>
                    <div class="text-xl text-gray-700 mb-6">
                        <p>ƒêi·ªÉm c·ªßa b·∫°n: <span id="user-final-score" class="font-bold text-green-600"></span></p>
                        <p>Th·ªùi gian ho√†n th√†nh: <span id="user-final-time" class="font-bold text-blue-600"></span></p>
                    </div>
                    <div class="flex flex-wrap justify-center gap-3">
                        <button onclick="reviewQuiz()" class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                            üìã Xem l·∫°i b√†i
                        </button>
                        <button onclick="backToQuizSelection()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            üìö Ch·ªçn ƒë·ªÅ kh√°c
                        </button>
                        <button onclick="userRestartQuiz()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            üîÑ L√†m l·∫°i
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quiz Review -->
            <div id="quiz-review-section" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üìã Xem l·∫°i b√†i l√†m</h2>
                        <button onclick="backToQuizComplete()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            ‚Üê Quay l·∫°i k·∫øt qu·∫£
                        </button>
                    </div>
                    
                    <div id="review-content" class="space-y-6">
                        <!-- Review questions will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative w-full h-full overflow-hidden">
            <div id="image-container" class="relative w-full h-full flex items-center justify-center overflow-hidden cursor-move">
                <img id="modal-image" src="" alt="C√¢u h·ªèi ph√≥ng to" class="max-w-none max-h-none object-contain select-none">
            </div>
            <div class="absolute top-4 right-4 flex space-x-2">
                <button onclick="zoomIn()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    üîç Ph√≥ng to
                </button>
                <button onclick="zoomOut()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    üîç Thu nh·ªè
                </button>
                <button onclick="resetZoom()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    ‚Üª Reset
                </button>
                <button onclick="closeImageModal()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">
                    ‚úï ƒê√≥ng
                </button>
            </div>
            <div class="absolute bottom-4 left-4 bg-white bg-opacity-80 text-black px-3 py-2 rounded-lg text-sm">
                üí° Cu·ªôn chu·ªôt ƒë·ªÉ zoom, k√©o ƒë·ªÉ di chuy·ªÉn
            </div>
        </div>
    </div>

    <!-- Admin Image Modal -->
    <div id="admin-image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
        <div class="relative w-full h-full overflow-hidden">
            <div id="admin-image-container" class="relative w-full h-full flex items-center justify-center overflow-hidden cursor-move">
                <img id="admin-modal-image" src="" alt="C√¢u h·ªèi ph√≥ng to" class="max-w-none max-h-none object-contain select-none">
            </div>
            <div class="absolute top-4 right-4 flex space-x-2">
                <button onclick="adminZoomIn()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">üîç Ph√≥ng to</button>
                <button onclick="adminZoomOut()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">üîç Thu nh·ªè</button>
                <button onclick="adminResetZoom()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">‚Üª Reset</button>
                <button onclick="closeAdminImageModal()" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black px-3 py-2 rounded-lg transition-all">‚úï ƒê√≥ng</button>
            </div>
            <div class="absolute bottom-4 left-4 bg-white bg-opacity-80 text-black px-3 py-2 rounded-lg text-sm">üí° Cu·ªôn chu·ªôt ƒë·ªÉ zoom, k√©o ƒë·ªÉ di chuy·ªÉn</div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="edit-question-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full relative">
            <h2 class="text-xl font-bold mb-4 text-gray-800">‚úèÔ∏è Ch·ªânh s·ª≠a c√¢u h·ªèi</h2>
            <form id="edit-question-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">H√¨nh ·∫£nh c√¢u h·ªèi:</label>
                    <div class="flex items-center space-x-2">
                        <img id="edit-preview-img" src="" alt="Preview" class="w-24 h-24 object-cover rounded cursor-pointer" onclick="openAdminImageModal(document.getElementById('edit-preview-img').src)">
                        <input type="file" id="edit-question-image-input" accept="image/*" class="p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung c√¢u h·ªèi:</label>
                    <textarea id="edit-question-content-input" rows="2" class="w-full p-2 border rounded"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n A:</label>
                        <input type="text" id="edit-answer-a" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n B:</label>
                        <input type="text" id="edit-answer-b" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n C:</label>
                        <input type="text" id="edit-answer-c" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n D:</label>
                        <input type="text" id="edit-answer-d" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                    <select id="edit-correct-answer" class="w-full p-2 border rounded">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" onclick="closeEditQuestionModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">H·ªßy</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentActiveSubject = 'T·ªïng h·ª£p';
        let currentActiveQuestionSet = 'B·ªô 1';
        let currentRole = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userScore = 0;
        let userSelectedAnswer = null;
        let quizStartTime = null;
        let quizTimer = null;
        let apiKeys = { key1: '', key2: '' };
        
        // Constants
        const ADMIN_PASSWORD = 'admin123'; // Thay ƒë·ªïi m·∫≠t kh·∫©u n√†y
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            setupImagePreview();
            
            // Test if functions are available
            console.log('showAdminLogin available:', typeof window.showAdminLogin === 'function');
            console.log('showUserLogin available:', typeof window.showUserLogin === 'function');
        });
        
        // Authentication functions
        function showAdminLogin() {
            console.log('Showing admin login...');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
        }
        
        function showUserLogin() {
            console.log('Showing user login...');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('user-login').classList.remove('hidden');
        }
        
        function backToMain() {
            console.log('Back to main...');
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('user-login').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Reset form inputs
            const adminPassword = document.getElementById('admin-password');
            const userName = document.getElementById('user-name');
            if (adminPassword) adminPassword.value = '';
            if (userName) userName.value = '';
        }
        
        function adminLogin(event) {
            if (event) event.preventDefault();
            const password = document.getElementById('admin-password').value;
            console.log('Admin login attempt with password:', password);
            
            if (password === ADMIN_PASSWORD) {
                console.log('Admin login successful!');
                currentUser = 'Admin';
                currentRole = 'admin';
                
                // Update admin name if element exists
                const adminNameElement = document.getElementById('admin-name');
                if (adminNameElement) {
                    adminNameElement.textContent = currentUser;
                }
                
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                
                loadAdminData();
            } else {
                alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Th·ª≠: admin123');
            }
        }
        
        function userLogin(event) {
            if (event) event.preventDefault();
            const userName = document.getElementById('user-name').value.trim();
            console.log('=== USER LOGIN DEBUG ===');
            console.log('User login attempt with name:', userName);
            
            if (userName) {
                console.log('‚úÖ User login successful!');
                currentUser = userName;
                currentRole = 'user';
                
                // Step 1: Hide all screens first
                console.log('Step 1: Hiding all screens...');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('user-login').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
                
                // Step 2: Check if user-dashboard exists
                const userDashboard = document.getElementById('user-dashboard');
                console.log('Step 2: User dashboard element:', userDashboard);
                
                if (!userDashboard) {
                    console.error('‚ùå ERROR: user-dashboard element not found!');
                    alert('CRITICAL ERROR: user-dashboard not found!\n\nPlease reload the page.');
                    // Fallback: show login screen again
                    document.getElementById('login-screen').classList.remove('hidden');
                    return;
                }
                
                // Step 3: Force show user dashboard with multiple methods
                console.log('Step 3: Showing user dashboard...');
                userDashboard.classList.remove('hidden');
                userDashboard.style.display = 'block';
                userDashboard.style.visibility = 'visible';
                userDashboard.style.opacity = '1';
                
                // Step 4: Verify visibility
                setTimeout(() => {
                    const isVisible = !userDashboard.classList.contains('hidden');
                    const computedStyle = window.getComputedStyle(userDashboard);
                    console.log('Step 4: Dashboard visibility check:');
                    console.log('- Has hidden class:', userDashboard.classList.contains('hidden'));
                    console.log('- Display style:', computedStyle.display);
                    console.log('- Visibility style:', computedStyle.visibility);
                    console.log('- Opacity style:', computedStyle.opacity);
                    
                    if (!isVisible || computedStyle.display === 'none') {
                        console.error('‚ùå Dashboard still not visible after all attempts!');
                        alert('DASHBOARD VISIBILITY ERROR!\n\nThe user dashboard element exists but is not showing.\nCheck browser console for details.');
                    } else {
                        console.log('‚úÖ Dashboard should be visible now!');
                    }
                }, 100);
                
                // Step 5: Update user name elements
                console.log('Step 5: Updating user name elements...');
                const currentUserNameElement = document.getElementById('current-user-name');
                if (currentUserNameElement) {
                    currentUserNameElement.textContent = currentUser;
                    console.log('‚úÖ Updated current-user-name:', currentUser);
                } else {
                    console.warn('‚ö†Ô∏è current-user-name element not found');
                }
                
                const welcomeUserNameElement = document.getElementById('welcome-user-name');
                if (welcomeUserNameElement) {
                    welcomeUserNameElement.textContent = currentUser;
                    console.log('‚úÖ Updated welcome-user-name:', currentUser);
                } else {
                    console.warn('‚ö†Ô∏è welcome-user-name element not found');
                }
                
                // Step 6: Load user data
                console.log('Step 6: Loading user data...');
                setTimeout(() => {
                    loadUserData();
                    console.log('‚úÖ User data loading initiated');
                }, 200);
                
                console.log('=== USER LOGIN COMPLETE ===');
                
            } else {
                alert('Vui l√≤ng nh·∫≠p t√™n!');
            }
        }
        
        // Add missing function for loadUserStats
        function loadUserStats() {
            console.log('Loading user stats...');
            // Update user stats with sample data
            const elements = {
                'total-attempts': 25,
                'average-score': '85',
                'total-time': '12h 30m',
                'best-score': '95'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value + (id === 'average-score' || id === 'best-score' ? '%' : '');
                }
            });
        }
        
        function logout() {
            console.log('Logging out...');
            currentUser = null;
            currentRole = null;
            
            // Hide all dashboards
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('user-dashboard').classList.add('hidden');
            
            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Clear forms
            document.getElementById('admin-password').value = '';
            document.getElementById('user-name').value = '';
        };
        
        // Global variables for new features
        let currentSubjectId = null;
        let currentQuestionSetId = null;
        let subjects = [];
        let questionSets = [];
        let currentZoom = 1;

        // Admin Tab Management
        window.showAdminTab = function(tabName) {
            // Hide all tabs
            document.getElementById('admin-tab-subjects').classList.add('hidden');
            document.getElementById('admin-tab-questions').classList.add('hidden');
            document.getElementById('admin-tab-settings').classList.add('hidden');
            document.getElementById('admin-tab-users').classList.add('hidden');
            
            // Remove active class from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.className = 'px-6 py-3 text-gray-600 hover:text-gray-800';
            });
            
            // Show selected tab
            document.getElementById(`admin-tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).className = 'px-6 py-3 border-b-2 border-blue-500 text-blue-600 font-semibold';
            
            // Load data for specific tabs
            if (tabName === 'subjects') {
                loadSubjects();
            } else if (tabName === 'questions') {
                loadSubjectsDropdown();
            }
        };

        // Question Management
        window.addQuestion = async function(event) {
            event.preventDefault();
            
            const subjectId = document.getElementById('question-subject').value;
            const questionSetId = document.getElementById('question-set').value;
            const imageFile = document.getElementById('question-image-input').files[0];
            
            if (!subjectId || !questionSetId) {
                alert('Vui l√≤ng ch·ªçn m√¥n h·ªçc v√† b·ªô ƒë·ªÅ');
                return;
            }
            
            if (!imageFile) {
                alert('Vui l√≤ng ch·ªçn h√¨nh ·∫£nh');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const question = {
                    subjectId: subjectId,
                    questionSetId: questionSetId,
                    image: e.target.result,
                    content: document.getElementById('question-content-input').value,
                    answers: {
                        A: document.getElementById('answer-a').value,
                        B: document.getElementById('answer-b').value,
                        C: document.getElementById('answer-c').value,
                        D: document.getElementById('answer-d').value
                    },
                    correctAnswer: document.getElementById('correct-answer').value,
                    createdAt: new Date(),
                    createdBy: currentUser
                };

                try {
                    // Save to Firebase
                    await addDoc(collection(window.db, 'questions'), question);
                    
                    // Refresh question list
                    await loadAdminQuestions();
                    await loadAdminStats();
                    
                    // Reset form but keep subject and question set selection
                    const form = document.querySelector('#admin-tab-questions form');
                    const subjectValue = document.getElementById('question-subject').value;
                    const questionSetValue = document.getElementById('question-set').value;
                    
                    form.reset();
                    
                    // Restore selections
                    document.getElementById('question-subject').value = subjectValue;
                    if (subjectValue) {
                        await loadQuestionSets(); // Reload question sets for the subject
                        document.getElementById('question-set').value = questionSetValue;
                    }
                    
                    document.getElementById('image-preview').classList.add('hidden');
                    
                    alert('Th√™m c√¢u h·ªèi th√†nh c√¥ng!');
                } catch (error) {
                    console.error('Error adding question:', error);
                    alert('L·ªói khi th√™m c√¢u h·ªèi (offline mode)');
                }
            };
            reader.readAsDataURL(imageFile);
        };

        window.deleteAdminQuestion = async function(questionId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?')) return;
            
            try {
                // Delete from Firebase
                await deleteDoc(doc(window.db, 'questions', questionId));
                
                // Refresh displays
                await loadAdminQuestions();
                await loadAdminStats();
                
                alert('ƒê√£ x√≥a c√¢u h·ªèi!');
            } catch (error) {
                console.error('Error deleting question:', error);
                // Fallback to localStorage
                questions = questions.filter(q => q.id !== questionId);
                localStorage.setItem('quiz-questions', JSON.stringify(questions));
                displayAdminQuestions();
                loadAdminStats();
                alert('ƒê√£ x√≥a c√¢u h·ªèi (offline mode)');
            }
        };

        // API Management
        function saveAdminApiKeys() {
            console.log('Saving API keys...');
            const key1 = document.getElementById('admin-api-key-1').value.trim();
            const key2 = document.getElementById('admin-api-key-2').value.trim();
            
            if (!key1 && !key2) {
                alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt API key!');
                return;
            }
            
            apiKeys.key1 = key1;
            apiKeys.key2 = key2;
            
            // Always save to localStorage first
            localStorage.setItem('gemini-api-keys', JSON.stringify(apiKeys));
            
            // Update global variable for immediate use
            window.apiKeys = apiKeys;
            
            alert('‚úÖ ƒê√£ l∆∞u API keys th√†nh c√¥ng!\n\nB√¢y gi·ªù b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c ch·ª©c nƒÉng AI.');
            
            console.log('API keys saved:', apiKeys);
        }
        
        // Admin functions  
        function loadAdminData() {
            console.log('Loading admin data...');
            loadSubjects(); // Load subjects first
            loadAdminQuestions();
            loadAdminApiKeys();
            loadAdminStats();
            loadUserStatistics();
        }
        
        function loadUserData() {
            console.log('Loading user data...');
            
            // Load API keys first
            loadAdminApiKeys();
            
            // Load user stats
            loadUserStats();
            
            // Make sure main-dashboard is visible
            const mainDashboard = document.getElementById('main-dashboard');
            if (mainDashboard) {
                mainDashboard.classList.remove('hidden');
                console.log('Main dashboard is now visible');
            } else {
                console.error('main-dashboard element not found!');
            }
            
            // Load quiz sets/subjects for user
            loadQuizSets();
            
            // Update daily motivation
            updateDailyMotivation();
        }
        
        function updateDailyMotivation() {
            const motivations = [
                "H√¥m nay b·∫°n s·∫Ω h·ªçc ƒë∆∞·ª£c ƒëi·ªÅu g√¨ m·ªõi? üåü",
                "M·ªói c√¢u h·ªèi l√† m·ªôt c∆° h·ªôi ƒë·ªÉ ph√°t tri·ªÉn! üöÄ",
                "Ki·∫øn th·ª©c l√† s·ª©c m·∫°nh, h√£y t√≠ch l≈©y th√™m! üí™",
                "H√†nh tr√¨nh ng√†n d·∫∑m b·∫Øt ƒë·∫ßu t·ª´ b∆∞·ªõc ch√¢n ƒë·∫ßu ti√™n! üë£",
                "H√¥m nay l√† ng√†y tuy·ªát v·ªùi ƒë·ªÉ h·ªçc t·∫≠p! ‚ú®"
            ];
            
            const randomMotivation = motivations[Math.floor(Math.random() * motivations.length)];
            const motivationElement = document.getElementById('daily-motivation');
            if (motivationElement) {
                motivationElement.textContent = randomMotivation;
            }
        }
        
        // Load functions with fallbacks
        function loadSubjects() {
            console.log('Loading subjects...');
            // For now, use sample data
            subjects = [
                { id: 'math', name: 'To√°n h·ªçc', color: 'blue' },
                { id: 'physics', name: 'V·∫≠t l√Ω', color: 'green' },
                { id: 'chemistry', name: 'H√≥a h·ªçc', color: 'purple' }
            ];
        }
        
        async function loadAdminQuestions() {
            try {
                console.log('Loading admin questions...');
                // Sample questions for demo
                questions = [
                    {
                        id: '1',
                        content: 'C√¢u h·ªèi m·∫´u 1',
                        answers: { A: 'ƒê√°p √°n A', B: 'ƒê√°p √°n B', C: 'ƒê√°p √°n C', D: 'ƒê√°p √°n D' },
                        correctAnswer: 'A',
                        subject: 'To√°n h·ªçc'
                    }
                ];
                displayAdminQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }
        
        function displayAdminQuestions(filteredQuestions = null) {
            const questionsList = document.getElementById('admin-questions-list');
            if (!questionsList) return;
            
            const questionsToShow = filteredQuestions || questions;
            
            if (questionsToShow.length === 0) {
                questionsList.innerHTML = '<p class="text-center text-gray-500 py-8">Ch∆∞a c√≥ c√¢u h·ªèi n√†o</p>';
                return;
            }
            
            questionsList.innerHTML = questionsToShow.map(question => `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${question.content || 'Kh√¥ng c√≥ n·ªôi dung'}</h4>
                            <p class="text-sm text-gray-600 mt-1">M√¥n: ${question.subject || 'Ch∆∞a ph√¢n lo·∫°i'}</p>
                        </div>
                        <button onclick="deleteAdminQuestion('${question.id}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadAdminStats() {
            console.log('Loading admin stats...');
            // Update stats with sample data
            const elements = {
                'total-questions': questions.length,
                'total-users': 10,
                'total-attempts': 25,
                'avg-score': '85%',
                'active-users': 3,
                'attempts-today': 5,
                'score-trend': '+5%',
                'total-sets-stat': 3,
                'ai-usage-stat': 15,
                'ai-success-rate': '98%'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        function loadAdminApiKeys() {
            console.log('Loading API keys...');
            
            // Load saved API keys from localStorage
            const savedKeys = localStorage.getItem('gemini-api-keys');
            if (savedKeys) {
                try {
                    const keys = JSON.parse(savedKeys);
                    apiKeys = keys;
                    window.apiKeys = keys; // Make globally available
                    
                    const key1Element = document.getElementById('admin-api-key-1');
                    const key2Element = document.getElementById('admin-api-key-2');
                    
                    if (key1Element) key1Element.value = keys.key1 || '';
                    if (key2Element) key2Element.value = keys.key2 || '';
                    
                    console.log('API keys loaded successfully:', keys);
                } catch (error) {
                    console.error('Error parsing saved API keys:', error);
                }
            } else {
                console.log('No saved API keys found');
            }
        }

        async function loadUserStatistics() {
            console.log('Loading user statistics...');
            const statsContainer = document.getElementById('users-statistics');
            if (!statsContainer) return;
            
            // Sample user statistics
            const sampleStats = [
                { name: 'Nguy·ªÖn VƒÉn A', attempts: 5, avgScore: 85, lastActive: '2 gi·ªù tr∆∞·ªõc' },
                { name: 'Tr·∫ßn Th·ªã B', attempts: 3, avgScore: 92, lastActive: '1 ng√†y tr∆∞·ªõc' },
                { name: 'L√™ VƒÉn C', attempts: 8, avgScore: 78, lastActive: '30 ph√∫t tr∆∞·ªõc' }
            ];
            
            statsContainer.innerHTML = sampleStats.map(user => `
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-gray-800">${user.name}</h4>
                            <p class="text-sm text-gray-600">${user.attempts} l·∫ßn l√†m b√†i ‚Ä¢ ƒêi·ªÉm TB: ${user.avgScore}%</p>
                        </div>
                        <div class="text-sm text-gray-500">${user.lastActive}</div>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadAdminQuestions() {
            try {
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questions = [];
                questionsSnapshot.forEach((doc) => {
                    questions.push({ id: doc.id, ...doc.data() });
                });
                displayAdminQuestions();
            } catch (error) {
                console.error('Error loading questions:', error);
                // Fallback to localStorage if Firebase fails
                const saved = localStorage.getItem('quiz-questions');
                if (saved) {
                    questions = JSON.parse(saved);
                    displayAdminQuestions();
                }
            }
        }
        
        function displayAdminQuestions(filteredQuestions = null) {
            const questionsList = document.getElementById('admin-questions-list');
            const questionsToShow = filteredQuestions || questions;
            
            if (questionsToShow.length === 0) {
                questionsList.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ c√¢u h·ªèi n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</p>';
                return;
            }

            // Load filter subjects on first load
            if (!filteredQuestions) {
                loadFilterSubjects();
            }

            questionsList.innerHTML = questionsToShow.map((question, index) => {
                // Find subject and question set names
                const subject = subjects.find(s => s.id === question.subjectId);
                const questionSet = questionSets.find(qs => qs.id === question.questionSetId);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="relative">
                                        <img src="${question.image}" alt="Question ${index + 1}" class="w-20 h-20 object-cover rounded-lg cursor-pointer" onclick="openAdminImageModal('${question.image}')">
                                        <button onclick="openAdminImageModal('${question.image}')" class="absolute bottom-1 right-1 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">üîç</button>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800">C√¢u ${index + 1}</h4>
                                        <p class="text-sm text-blue-600 font-medium">üìö ${subject?.name || 'Ch∆∞a r√µ m√¥n'} - üìã ${questionSet?.name || 'Ch∆∞a r√µ b·ªô ƒë·ªÅ'}</p>
                                        <p class="text-sm text-gray-600">${question.content || 'C√¢u h·ªèi t·ª´ h√¨nh ·∫£nh'}</p>
                                        <p class="text-sm text-green-600 font-medium">ƒê√°p √°n: ${question.correctAnswer}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>A. ${question.answers.A}</div>
                                    <div>B. ${question.answers.B}</div>
                                    <div>C. ${question.answers.C}</div>
                                    <div>D. ${question.answers.D}</div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <button onclick="editAdminQuestion('${question.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">‚úèÔ∏è S·ª≠a</button>
                                <button onclick="deleteAdminQuestion('${question.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">üóëÔ∏è X√≥a</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function loadFilterSubjects() {
            const filterSubject = document.getElementById('filter-subject');
            if (!filterSubject) return;
            
            filterSubject.innerHTML = '<option value="">T·∫•t c·∫£ m√¥n h·ªçc</option>';
            subjects.forEach(subject => {
                filterSubject.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
            });
        }

        window.loadFilterQuestionSets = function() {
            const subjectId = document.getElementById('filter-subject').value;
            const filterQuestionSet = document.getElementById('filter-question-set');
            
            filterQuestionSet.innerHTML = '<option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>';
            
            if (subjectId) {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subjectId);
                subjectQuestionSets.forEach(qs => {
                    filterQuestionSet.innerHTML += `<option value="${qs.id}">${qs.name}</option>`;
                });
            }
            
            // Apply filter after changing subject
            filterQuestions();
        };

        window.filterQuestions = function() {
            const subjectId = document.getElementById('filter-subject').value;
            const questionSetId = document.getElementById('filter-question-set').value;
            
            let filteredQuestions = questions;
            
            if (subjectId) {
                filteredQuestions = filteredQuestions.filter(q => q.subjectId === subjectId);
            }
            
            if (questionSetId) {
                filteredQuestions = filteredQuestions.filter(q => q.questionSetId === questionSetId);
            }
            
            displayAdminQuestions(filteredQuestions);
        };

        window.resetQuestionFilter = function() {
            document.getElementById('filter-subject').value = '';
            document.getElementById('filter-question-set').innerHTML = '<option value="">T·∫•t c·∫£ b·ªô ƒë·ªÅ</option>';
            displayAdminQuestions();
        };
        
        async function loadAdminStats() {
            // Load statistics
            document.getElementById('total-questions-stat').textContent = questions.length;
            
            try {
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const users = new Set();
                let totalAttempts = 0;
                let totalScore = 0;
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    users.add(data.userName);
                    totalAttempts++;
                    totalScore += data.score || 0;
                });
                
                document.getElementById('total-users-stat').textContent = users.size;
                document.getElementById('total-attempts-stat').textContent = totalAttempts;
                document.getElementById('avg-score-stat').textContent = totalAttempts > 0 ? 
                    Math.round((totalScore / totalAttempts / questions.length) * 100) + '%' : '0%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAdminApiKeys() {
            try {
                const settingsSnapshot = await getDocs(collection(window.db, 'settings'));
                settingsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.type === 'apiKeys') {
                        apiKeys = data.keys;
                        document.getElementById('admin-api-key-1').value = apiKeys.key1 || '';
                        document.getElementById('admin-api-key-2').value = apiKeys.key2 || '';
                    }
                });
            } catch (error) {
                console.error('Error loading API keys:', error);
                // Fallback to localStorage
                const saved = localStorage.getItem('gemini-api-keys');
                if (saved) {
                    apiKeys = JSON.parse(saved);
                    document.getElementById('admin-api-key-1').value = apiKeys.key1 || '';
                    document.getElementById('admin-api-key-2').value = apiKeys.key2 || '';
                }
            }
        }

        async function loadUserStatistics() {
            try {
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const userStats = {};
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const userName = data.userName;
                    
                    if (!userStats[userName]) {
                        userStats[userName] = {
                            name: userName,
                            attempts: 0,
                            totalScore: 0,
                            bestScore: 0,
                            bestPercentage: 0,
                            totalTime: 0,
                            sessions: []
                        };
                    }
                    
                    // Each session is counted separately 
                    userStats[userName].attempts++;
                    userStats[userName].totalScore += data.score || 0;
                    userStats[userName].totalTime += data.completionTime || 0;
                    userStats[userName].bestScore = Math.max(userStats[userName].bestScore, data.score || 0);
                    userStats[userName].bestPercentage = Math.max(userStats[userName].bestPercentage, data.percentage || 0);
                    
                    // Store session details
                    userStats[userName].sessions.push({
                        score: data.score,
                        totalQuestions: data.totalQuestions,
                        percentage: data.percentage,
                        completionTime: data.completionTime,
                        completedAt: data.completedAt,
                        questionSetId: data.questionSetId
                    });
                });
                
                // Sort sessions by date for each user
                Object.values(userStats).forEach(stat => {
                    stat.sessions.sort((a, b) => {
                        const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                        const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                        return dateB - dateA; // Most recent first
                    });
                    
                    // Get last attempt
                    if (stat.sessions.length > 0) {
                        const lastSession = stat.sessions[0];
                        stat.lastAttempt = lastSession.completedAt?.toDate ? 
                            lastSession.completedAt.toDate().toLocaleString() : 
                            new Date(lastSession.completedAt).toLocaleString();
                    }
                });
                
                displayUserStatistics(Object.values(userStats));
            } catch (error) {
                console.error('Error loading user statistics:', error);
                // Try loading from localStorage backup
                try {
                    const backupSessions = JSON.parse(localStorage.getItem('userSessions') || '[]');
                    if (backupSessions.length > 0) {
                        console.log('Loading from localStorage backup');
                        // Process backup data similar to Firebase data
                        // This is a simplified version
                        const container = document.getElementById('users-statistics');
                        container.innerHTML = '<p class="text-yellow-600 text-center py-8">Hi·ªÉn th·ªã d·ªØ li·ªáu backup t·ª´ localStorage</p>';
                    }
                } catch (backupError) {
                    console.error('Error loading backup data:', backupError);
                }
            }
        }

        function displayUserStatistics(userStats) {
            const container = document.getElementById('users-statistics');
            
            if (userStats.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o l√†m b√†i</p>';
                return;
            }
            
            // Sort users by total attempts (most active first)
            userStats.sort((a, b) => b.attempts - a.attempts);
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T√™n ng∆∞·ªùi d√πng</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">T·ªïng l·∫ßn l√†m</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒêi·ªÉm cao nh·∫•t</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ph·∫ßn trƒÉm t·ªët nh·∫•t</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Th·ªùi gian TB</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L·∫ßn cu·ªëi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chi ti·∫øt</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${userStats.map((stat, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <div class="flex items-center">
                                            <div class="text-2xl mr-2">${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : 'üë§'}</div>
                                            ${stat.name}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-semibold">${stat.attempts}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">
                                        ${stat.bestScore}/${stat.sessions[0]?.totalQuestions || '?'}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${stat.bestPercentage >= 80 ? 'text-green-600' : stat.bestPercentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                        ${stat.bestPercentage}%
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${formatTime(Math.round(stat.totalTime / stat.attempts))}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${stat.lastAttempt || 'Ch∆∞a c√≥'}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="showUserDetails('${stat.name}')" class="text-blue-600 hover:text-blue-800 font-medium">
                                            üìä Xem chi ti·∫øt
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- User Detail Modal -->
                <div id="user-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-96 overflow-y-auto m-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="user-detail-title" class="text-xl font-bold text-gray-800"></h3>
                            <button onclick="closeUserDetails()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                        </div>
                        <div id="user-detail-content">
                            <!-- User session details will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
        }

        window.showUserDetails = async function(userName) {
            document.getElementById('user-detail-title').textContent = `Chi ti·∫øt c·ªßa ${userName}`;
            document.getElementById('user-detail-content').innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-4"></div>
                    <span class="text-gray-600">ƒêang t·∫£i chi ti·∫øt...</span>
                </div>
            `;
            document.getElementById('user-detail-modal').classList.remove('hidden');
            
            try {
                // Load user sessions
                const usersSnapshot = await getDocs(collection(window.db, 'userSessions'));
                const userSessions = [];
                
                usersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.userName === userName) {
                        userSessions.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // Sort sessions by date (most recent first)
                userSessions.sort((a, b) => {
                    const dateA = a.completedAt?.toDate ? a.completedAt.toDate() : new Date(a.completedAt);
                    const dateB = b.completedAt?.toDate ? b.completedAt.toDate() : new Date(b.completedAt);
                    return dateB - dateA;
                });
                
                if (userSessions.length === 0) {
                    document.getElementById('user-detail-content').innerHTML = `
                        <p class="text-gray-500 text-center py-8">Ng∆∞·ªùi d√πng n√†y ch∆∞a c√≥ l·∫ßn l√†m b√†i n√†o</p>
                    `;
                    return;
                }
                
                // Display user sessions
                document.getElementById('user-detail-content').innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">üìä T·ªïng quan</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-600">${userSessions.length}</div>
                                    <div class="text-gray-600">T·ªïng l·∫ßn l√†m</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-green-600">${Math.max(...userSessions.map(s => s.score || 0))}</div>
                                    <div class="text-gray-600">ƒêi·ªÉm cao nh·∫•t</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-purple-600">${Math.max(...userSessions.map(s => s.percentage || 0))}%</div>
                                    <div class="text-gray-600">% t·ªët nh·∫•t</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-orange-600">${formatTime(Math.round(userSessions.reduce((sum, s) => sum + (s.completionTime || 0), 0) / userSessions.length))}</div>
                                    <div class="text-gray-600">Th·ªùi gian TB</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="max-h-96 overflow-y-auto">
                            <h4 class="font-semibold text-gray-800 mb-3">üìã L·ªãch s·ª≠ l√†m b√†i</h4>
                            <div class="space-y-3">
                                ${userSessions.map((session, index) => {
                                    const completedAt = session.completedAt?.toDate ? 
                                        session.completedAt.toDate() : 
                                        new Date(session.completedAt);
                                    
                                    return `
                                        <div class="border border-gray-200 rounded-lg p-4 ${index === 0 ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-sm font-medium text-gray-600">
                                                        ${index === 0 ? 'üïê L·∫ßn l√†m m·ªõi nh·∫•t' : `üìÖ L·∫ßn ${userSessions.length - index}`}
                                                    </span>
                                                    ${session.percentage >= 80 ? 'üèÜ' : session.percentage >= 60 ? 'üëç' : 'üí™'}
                                                </div>
                                                <span class="text-xs text-gray-500">
                                                    ${completedAt.toLocaleDateString()} ${completedAt.toLocaleTimeString()}
                                                </span>
                                            </div>
                                            <div class="grid grid-cols-3 gap-4 text-sm">
                                                <div>
                                                    <span class="text-gray-600">ƒêi·ªÉm:</span>
                                                    <span class="font-semibold text-green-600 ml-1">
                                                        ${session.score}/${session.totalQuestions}
                                                    </span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Ph·∫ßn trƒÉm:</span>
                                                    <span class="font-semibold text-blue-600 ml-1">${session.percentage}%</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Th·ªùi gian:</span>
                                                    <span class="font-semibold text-purple-600 ml-1">${formatTime(session.completionTime || 0)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                document.getElementById('user-detail-content').innerHTML = `
                    <p class="text-red-500 text-center py-8">‚ùå L·ªói khi t·∫£i chi ti·∫øt ng∆∞·ªùi d√πng</p>
                `;
            }
        };

        window.closeUserDetails = function() {
            document.getElementById('user-detail-modal').classList.add('hidden');
        };

        // User Functions
        function loadUserData() {
            loadAdminApiKeys(); // Load API keys for user too
            loadQuizSets();
        }

        async function loadQuizSets() {
            try {
                // Load subjects
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                // Load question sets  
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    questionSets.push({ id: doc.id, ...doc.data() });
                });
                
                displaySubjectsForUser();
            } catch (error) {
                console.error('Error loading quiz sets:', error);
                document.getElementById('quiz-sets-list').innerHTML = `
                    <div class="col-span-2 text-center py-12">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-2xl font-bold text-gray-600 mb-4">L·ªói k·∫øt n·ªëi</h3>
                        <p class="text-gray-500">Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªÅ thi</p>
                    </div>
                `;
            }
        }

        function displaySubjectsForUser() {
            const container = document.getElementById('quiz-sets-list');
            
            if (subjects.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-12">
                        <div class="text-6xl mb-4">üìö</div>
                        <h3 class="text-2xl font-bold text-gray-600 mb-4">Ch∆∞a c√≥ m√¥n h·ªçc n√†o</h3>
                        <p class="text-gray-500">Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ th√™m m√¥n h·ªçc</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = subjects.map(subject => {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subject.id);
                
                return `
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-blue-500 transition-colors">
                        <div class="text-center mb-4">
                            <div class="text-4xl mb-2">üìñ</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${subject.name}</h3>
                            <p class="text-gray-600 text-sm">${subject.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                            <p class="text-blue-600 font-semibold mt-2">S·ªë b·ªô ƒë·ªÅ: ${subjectQuestionSets.length}</p>
                        </div>
                        
                        <div class="space-y-2">
                            ${subjectQuestionSets.map(qs => `
                                <button onclick="selectQuestionSet('${qs.id}', '${subject.name}', '${qs.name}')" 
                                        class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    üìù ${qs.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.selectQuestionSet = async function(questionSetId, subjectName, questionSetName) {
            // Stop any existing timer first
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            // Reset ALL quiz states and UI elements
            currentQuestionIndex = 0;
            userScore = 0;
            userSelectedAnswer = null;
            userAnswers = []; // Reset answers array
            
            // Hide ALL quiz related UI elements
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-quiz-content').classList.add('hidden');
            document.getElementById('quiz-selection').classList.remove('hidden');
            
            // Load questions for this question set
            try {
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questions = [];
                questionsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.questionSetId === questionSetId) {
                        questions.push({ id: doc.id, ...data });
                    }
                });
                
                if (questions.length === 0) {
                    alert('B·ªô ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o!');
                    return;
                }
                
                // Store current selection
                currentSubjectId = null; // We'll find it from questionSetId
                currentQuestionSetId = questionSetId;
                
                // Update UI to show selected quiz info
                document.getElementById('quiz-selection').querySelector('h2').textContent = 
                    `${subjectName} - ${questionSetName}`;
                document.getElementById('quiz-selection').querySelector('p').textContent = 
                    `S·∫µn s√†ng l√†m b√†i v·ªõi ${questions.length} c√¢u h·ªèi`;
                    
                // Show start button or auto-start
                setTimeout(() => {
                    if (confirm(`B·∫Øt ƒë·∫ßu l√†m b√†i "${questionSetName}" v·ªõi ${questions.length} c√¢u h·ªèi?`)) {
                        startUserQuiz();
                    }
                }, 100);
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('L·ªói khi t·∫£i c√¢u h·ªèi!');
            }
        };

        window.startUserQuiz = function() {
            document.getElementById('quiz-selection').classList.add('hidden');
            document.getElementById('user-quiz-content').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            userScore = 0;
            quizStartTime = Date.now();
            userAnswers = []; // Reset user answers for new quiz
            
            startQuizTimer();
            updateUserQuizDisplay();
        };

        window.backToQuizSelection = function() {
            document.getElementById('user-quiz-content').classList.add('hidden');
            document.getElementById('quiz-selection').classList.remove('hidden');
            
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
        };

        function startQuizTimer() {
            quizTimer = setInterval(() => {
                const elapsed = Date.now() - quizStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                document.getElementById('quiz-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function updateUserQuizDisplay() {
            if (currentQuestionIndex >= questions.length) {
                showUserQuizComplete();
                return;
            }

            const question = questions[currentQuestionIndex];
            
            document.getElementById('user-current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('user-total-questions').textContent = questions.length;
            document.getElementById('user-score').textContent = userScore;

            document.getElementById('user-question-image').src = question.image;
            document.getElementById('user-question-text').textContent = question.content || '';

            document.getElementById('user-option-A').querySelector('.answer-text').textContent = question.answers.A;
            document.getElementById('user-option-B').querySelector('.answer-text').textContent = question.answers.B;
            document.getElementById('user-option-C').querySelector('.answer-text').textContent = question.answers.C;
            document.getElementById('user-option-D').querySelector('.answer-text').textContent = question.answers.D;

            resetUserAnswerButtons();
            document.getElementById('user-ai-explanation').classList.add('hidden');
            document.getElementById('user-next-btn').classList.add('hidden');
            userSelectedAnswer = null;
        }

        window.userSelectAnswer = function(answer) {
            if (userSelectedAnswer) return;
            
            userSelectedAnswer = answer;
            
            // Store user answer for review
            if (!userAnswers) userAnswers = [];
            userAnswers[currentQuestionIndex] = answer;
            
            const question = questions[currentQuestionIndex];
            const isCorrect = answer === question.correctAnswer;

            document.querySelectorAll('.user-answer-btn').forEach(btn => {
                btn.classList.add('pointer-events-none');
                if (btn.id === `user-option-${answer}`) {
                    btn.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                    btn.classList.add(isCorrect ? 'bg-green-100' : 'bg-red-100');
                }
                if (btn.id === `user-option-${question.correctAnswer}`) {
                    btn.classList.add('border-green-500', 'bg-green-100');
                }
            });

            if (isCorrect) {
                userScore++;
                document.getElementById('user-score').textContent = userScore;
                setTimeout(() => {
                    document.getElementById('user-next-btn').classList.remove('hidden');
                }, 500);
            } else {
                getUserAIExplanation(question, answer);
            }
        };

        async function getUserAIExplanation(question, selectedAnswer) {
            const explanationDiv = document.getElementById('user-ai-explanation');
            const loadingSpinner = document.getElementById('user-loading-ai');
            const explanationText = document.getElementById('user-explanation-text');

            explanationDiv.classList.remove('hidden');
            loadingSpinner.classList.remove('hidden');
            explanationText.textContent = 'ƒêang ph√¢n t√≠ch c√¢u tr·∫£ l·ªùi...';

            try {
                const explanation = await callGeminiAPI(question, selectedAnswer);
                explanationText.textContent = explanation;
            } catch (error) {
                explanationText.textContent = `Kh√¥ng th·ªÉ l·∫•y gi·∫£i th√≠ch t·ª´ AI. ƒê√°p √°n ƒë√∫ng l√† ${question.correctAnswer}: ${question.answers[question.correctAnswer]}`;
            } finally {
                loadingSpinner.classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('user-next-btn').classList.remove('hidden');
                }, 1000);
            }
        }

        async function callGeminiAPI(question, selectedAnswer) {
            const prompt = `T√¥i ƒëang l√†m b√†i tr·∫Øc nghi·ªám. ƒê√¢y l√† c√¢u h·ªèi c√≥ h√¨nh ·∫£nh. T√¥i ƒë√£ ch·ªçn ƒë√°p √°n ${selectedAnswer}, nh∆∞ng c√≥ v·∫ª sai. 
H√£y gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n ƒë√≥ sai v√† ƒë√°p √°n ƒë√∫ng l√† g√¨ d·ª±a tr√™n n·ªôi dung c√¢u h·ªèi trong h√¨nh. 
H√£y r√µ r√†ng v√† d·ªÖ hi·ªÉu.

C√¢u h·ªèi: ${question.content || 'Xem trong h√¨nh'}
C√°c ƒë√°p √°n:
A. ${question.answers.A}
B. ${question.answers.B}
C. ${question.answers.C}  
D. ${question.answers.D}

ƒê√°p √°n ƒë√∫ng: ${question.correctAnswer}
ƒê√°p √°n t√¥i ch·ªçn: ${selectedAnswer}`;

            // Try API key 1 first, then API key 2
            const keys = [apiKeys.key1, apiKeys.key2].filter(key => key);
            
            for (const apiKey of keys) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inline_data: {
                                            mime_type: getImageMimeType(question.image),
                                            data: question.image.split(',')[1]
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                }
            }
            
            throw new Error('Both API keys failed');
        }

        function getImageMimeType(dataUrl) {
            const matches = dataUrl.match(/^data:([^;]+);base64,/);
            return matches ? matches[1] : 'image/jpeg';
        }

        window.userNextQuestion = function() {
            currentQuestionIndex++;
            updateUserQuizDisplay();
        };

        async function showUserQuizComplete() {
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const completionTime = Math.floor((Date.now() - quizStartTime) / 1000);
            
            document.getElementById('user-question-content').classList.add('hidden');
            document.getElementById('user-quiz-complete').classList.remove('hidden');
            document.getElementById('user-final-score').textContent = `${userScore}/${questions.length}`;
            document.getElementById('user-final-time').textContent = formatTime(completionTime);
            
            // Save session to Firebase - Always create new session
            try {
                const sessionData = {
                    userName: currentUser,
                    score: userScore,
                    totalQuestions: questions.length,
                    completionTime: completionTime,
                    completedAt: new Date(),
                    questionSetId: currentQuestionSetId,
                    sessionId: Date.now().toString(), // Unique session ID
                    percentage: Math.round((userScore / questions.length) * 100)
                };
                
                // Create custom document ID with username + timestamp for easier management
                const customDocId = `${currentUser.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}`;
                await setDoc(doc(window.db, 'userSessions', customDocId), sessionData);
                console.log('Session saved successfully:', sessionData);
            } catch (error) {
                console.error('Error saving session:', error);
                // Save to localStorage as backup
                const existingSessions = JSON.parse(localStorage.getItem('userSessions') || '[]');
                existingSessions.push({
                    userName: currentUser,
                    score: userScore,
                    totalQuestions: questions.length,
                    completionTime: completionTime,
                    completedAt: new Date().toISOString(),
                    questionSetId: currentQuestionSetId,
                    sessionId: Date.now().toString(),
                    percentage: Math.round((userScore / questions.length) * 100)
                });
                localStorage.setItem('userSessions', JSON.stringify(existingSessions));
            }
        }

        window.userRestartQuiz = function() {
            // Stop existing timer
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            // Reset all states
            currentQuestionIndex = 0;
            userScore = 0;
            userSelectedAnswer = null;
            userAnswers = []; // Reset answers for new attempt
            quizStartTime = Date.now();
            
            // Hide completion and review screens, show question content
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-question-content').classList.remove('hidden');
            
            // Restart timer and display
            startQuizTimer();
            updateUserQuizDisplay();
        };

        function resetUserAnswerButtons() {
            document.querySelectorAll('.user-answer-btn').forEach(btn => {
                btn.className = 'user-answer-btn p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all';
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Image preview setup
        function setupImagePreview() {
            const imageInput = document.getElementById('question-image-input');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');

            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // ================== NEW FEATURES ==================
        
        // Subject Management
        function addSubject(event) {
            event.preventDefault();
            
            const subjectName = document.getElementById('subject-name').value.trim();
            const subjectDescription = document.getElementById('subject-description').value.trim();
            
            if (!subjectName) {
                alert('Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc!');
                return;
            }
            
            const subject = {
                id: Date.now().toString(),
                name: subjectName,
                description: subjectDescription,
                color: getRandomColor(),
                createdAt: new Date(),
                createdBy: currentUser
            };

            // Add to local subjects array
            subjects.push(subject);
            
            // Save to localStorage
            localStorage.setItem('quiz-subjects', JSON.stringify(subjects));
            
            // Reset form
            document.querySelector('#admin-tab-subjects form').reset();
            
            // Refresh subjects display
            loadSubjects();
            
            alert('‚úÖ ƒê√£ th√™m m√¥n h·ªçc th√†nh c√¥ng!');
            console.log('Subject added:', subject);
        }
        
        function getRandomColor() {
            const colors = ['blue', 'green', 'purple', 'red', 'yellow', 'indigo', 'pink', 'orange'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        window.deleteSubject = async function(subjectId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc n√†y? T·∫•t c·∫£ b·ªô ƒë·ªÅ v√† c√¢u h·ªèi s·∫Ω b·ªã x√≥a!')) return;
            
            try {
                // Delete subject
                await deleteDoc(doc(window.db, 'subjects', subjectId));
                
                // Delete all question sets of this subject
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSetsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.subjectId === subjectId) {
                        await deleteDoc(doc(window.db, 'questionSets', docSnap.id));
                    }
                });
                
                // Delete all questions of this subject
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questionsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.subjectId === subjectId) {
                        await deleteDoc(doc(window.db, 'questions', docSnap.id));
                    }
                });
                
                loadSubjects();
                alert('ƒê√£ x√≥a m√¥n h·ªçc v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!');
            } catch (error) {
                console.error('Error deleting subject:', error);
                alert('L·ªói khi x√≥a m√¥n h·ªçc');
            }
        };

        window.addQuestionSet = async function(subjectId) {
            const name = prompt('Nh·∫≠p t√™n b·ªô ƒë·ªÅ m·ªõi:');
            if (!name) return;
            
            try {
                await addDoc(collection(window.db, 'questionSets'), {
                    name: name,
                    subjectId: subjectId,
                    createdAt: new Date(),
                    createdBy: currentUser
                });
                
                loadSubjects();
                alert('Th√™m b·ªô ƒë·ªÅ th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error adding question set:', error);
                alert('L·ªói khi th√™m b·ªô ƒë·ªÅ');
            }
        };

        window.deleteQuestionSet = async function(questionSetId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô ƒë·ªÅ n√†y? T·∫•t c·∫£ c√¢u h·ªèi s·∫Ω b·ªã x√≥a!')) return;
            
            try {
                // Delete question set
                await deleteDoc(doc(window.db, 'questionSets', questionSetId));
                
                // Delete all questions of this set
                const questionsSnapshot = await getDocs(collection(window.db, 'questions'));
                questionsSnapshot.forEach(async (docSnap) => {
                    const data = docSnap.data();
                    if (data.questionSetId === questionSetId) {
                        await deleteDoc(doc(window.db, 'questions', docSnap.id));
                    }
                });
                
                loadSubjects();
                alert('ƒê√£ x√≥a b·ªô ƒë·ªÅ v√† t·∫•t c·∫£ c√¢u h·ªèi!');
            } catch (error) {
                console.error('Error deleting question set:', error);
                alert('L·ªói khi x√≥a b·ªô ƒë·ªÅ');
            }
        };

        async function loadSubjects() {
            try {
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                // Load question sets for each subject
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                questionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    questionSets.push({ id: doc.id, ...doc.data() });
                });
                
                displaySubjects();
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        function displaySubjects() {
            const container = document.getElementById('subjects-list');
            
            if (subjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ m√¥n h·ªçc n√†o</p>';
                return;
            }
            
            container.innerHTML = subjects.map(subject => {
                const subjectQuestionSets = questionSets.filter(qs => qs.subjectId === subject.id);
                
                return `
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">${subject.name}</h4>
                                <p class="text-gray-600">${subject.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                                <p class="text-sm text-blue-600 mt-2">S·ªë b·ªô ƒë·ªÅ: ${subjectQuestionSets.length}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addQuestionSet('${subject.id}')" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                    ‚ûï Th√™m b·ªô ƒë·ªÅ
                                </button>
                                <button onclick="deleteSubject('${subject.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                    üóëÔ∏è X√≥a m√¥n
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${subjectQuestionSets.map(qs => `
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h5 class="font-semibold text-gray-700">${qs.name}</h5>
                                            <p class="text-sm text-gray-500">ID: ${qs.id.substr(0, 8)}...</p>
                                        </div>
                                        <button onclick="deleteQuestionSet('${qs.id}')" class="px-2 py-1 bg-red-400 text-white rounded hover:bg-red-500 transition-colors text-sm">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadSubjectsDropdown() {
            try {
                const subjectsSnapshot = await getDocs(collection(window.db, 'subjects'));
                subjects = [];
                subjectsSnapshot.forEach((doc) => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                const subjectSelect = document.getElementById('question-subject');
                subjectSelect.innerHTML = '<option value="">Ch·ªçn m√¥n h·ªçc</option>';
                subjects.forEach(subject => {
                    subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading subjects dropdown:', error);
            }
        }

        window.loadQuestionSets = async function() {
            const subjectId = document.getElementById('question-subject').value;
            if (!subjectId) return;
            
            try {
                const questionSetsSnapshot = await getDocs(collection(window.db, 'questionSets'));
                const subjectQuestionSets = [];
                questionSetsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.subjectId === subjectId) {
                        subjectQuestionSets.push({ id: doc.id, ...data });
                    }
                });
                
                const questionSetSelect = document.getElementById('question-set');
                questionSetSelect.innerHTML = '<option value="">Ch·ªçn b·ªô ƒë·ªÅ</option>';
                subjectQuestionSets.forEach(qs => {
                    questionSetSelect.innerHTML += `<option value="${qs.id}">${qs.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading question sets:', error);
            }
        };

        // Image Zoom Functions with Mouse Interaction
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let imgPosX = 0;
        let imgPosY = 0;

        window.openImageModal = function() {
            const originalImg = document.getElementById('user-question-image');
            const modalImg = document.getElementById('modal-image');
            const container = document.getElementById('image-container');
            
            modalImg.src = originalImg.src;
            currentZoom = 1;
            imgPosX = 0;
            imgPosY = 0;
            
            updateImageTransform();
            
            document.getElementById('image-modal').classList.remove('hidden');
            
            // Setup mouse events
            setupImageInteraction();
        };

        function updateImageTransform() {
            const modalImg = document.getElementById('modal-image');
            modalImg.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${currentZoom})`;
        }

        function setupImageInteraction() {
            const container = document.getElementById('image-container');
            const modalImg = document.getElementById('modal-image');
            
            // Mouse wheel zoom
            container.onwheel = function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentZoom = Math.max(0.5, Math.min(5, currentZoom + delta));
                updateImageTransform();
            };
            
            // Mouse drag
            modalImg.onmousedown = function(e) {
                e.preventDefault();
                isDragging = true;
                dragStartX = e.clientX - imgPosX;
                dragStartY = e.clientY - imgPosY;
                container.style.cursor = 'grabbing';
            };
            
            container.onmousemove = function(e) {
                if (!isDragging) return;
                e.preventDefault();
                imgPosX = e.clientX - dragStartX;
                imgPosY = e.clientY - dragStartY;
                updateImageTransform();
            };
            
            container.onmouseup = function() {
                isDragging = false;
                container.style.cursor = 'move';
            };
            
            container.onmouseleave = function() {
                isDragging = false;
                container.style.cursor = 'move';
            };
        }

        window.closeImageModal = function() {
            document.getElementById('image-modal').classList.add('hidden');
            isDragging = false;
        };

        window.zoomIn = function() {
            currentZoom = Math.min(currentZoom + 0.3, 5);
            updateImageTransform();
        };

        window.zoomOut = function() {
            currentZoom = Math.max(currentZoom - 0.3, 0.5);
            updateImageTransform();
        };

        window.resetZoom = function() {
            currentZoom = 1;
            imgPosX = 0;
            imgPosY = 0;
            updateImageTransform();
        };

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target === modal) {
                closeImageModal();
            }
        });

        // Quiz Review Functions
        let userAnswers = []; // Store user answers for review

        window.reviewQuiz = function() {
            document.getElementById('user-quiz-complete').classList.add('hidden');
            document.getElementById('quiz-review-section').classList.remove('hidden');
            displayQuizReview();
        };

        window.backToQuizComplete = function() {
            document.getElementById('quiz-review-section').classList.add('hidden');
            document.getElementById('user-quiz-complete').classList.remove('hidden');
        };

        function displayQuizReview() {
            const reviewContent = document.getElementById('review-content');
            
            if (!userAnswers || userAnswers.length === 0) {
                reviewContent.innerHTML = '<p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu b√†i l√†m ƒë·ªÉ xem l·∫°i</p>';
                return;
            }
            
            reviewContent.innerHTML = questions.map((question, index) => {
                const userAnswer = userAnswers[index] || 'Kh√¥ng tr·∫£ l·ªùi';
                const isCorrect = userAnswer === question.correctAnswer;
                const correctAnswer = question.correctAnswer;
                
                return `
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${isCorrect ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex items-start justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">C√¢u ${index + 1}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-sm ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${isCorrect ? '‚úÖ ƒê√∫ng' : '‚ùå Sai'}
                                </span>
                                ${!isCorrect ? `<button onclick="showAIExplanationReview(${index})" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">ü§ñ Gi·∫£i th√≠ch AI</button>` : ''}
                            </div>
                        </div>
                        
                        ${question.image ? `
                            <div class="mb-4">
                                <img src="${question.image}" alt="C√¢u h·ªèi ${index + 1}" 
                                     class="max-w-full h-auto rounded-lg shadow-sm cursor-pointer hover:opacity-90 transition-opacity max-h-96 object-contain"
                                     onclick="openImageModal(); document.getElementById('modal-image').src='${question.image}'">
                            </div>
                        ` : ''}
                        
                        ${question.content ? `<p class="text-gray-700 mb-4">${question.content}</p>` : ''}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            ${Object.entries(question.answers).map(([key, value]) => {
                                let bgClass = 'bg-gray-50 border-gray-200';
                                let textClass = 'text-gray-700';
                                let icon = '';
                                
                                if (key === correctAnswer) {
                                    bgClass = 'bg-green-100 border-green-500';
                                    textClass = 'text-green-800 font-semibold';
                                    icon = '‚úÖ ';
                                } else if (key === userAnswer && key !== correctAnswer) {
                                    bgClass = 'bg-red-100 border-red-500';
                                    textClass = 'text-red-800';
                                    icon = '‚ùå ';
                                }
                                
                                return `
                                    <div class="p-3 rounded-lg border-2 ${bgClass} ${textClass}">
                                        ${icon}${key}. ${value}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            <p><strong>B·∫°n ch·ªçn:</strong> ${userAnswer}</p>
                            <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctAnswer}</p>
                        </div>
                        
                        <div id="ai-explanation-${index}" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">ü§ñ Gi·∫£i th√≠ch c·ªßa AI:</h4>
                            <div id="ai-explanation-content-${index}" class="text-blue-700">
                                <div class="flex items-center space-x-2">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                    <span>ƒêang t·∫°o gi·∫£i th√≠ch...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.showAIExplanationReview = async function(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = userAnswers[questionIndex];
            const explanationDiv = document.getElementById(`ai-explanation-${questionIndex}`);
            const explanationContent = document.getElementById(`ai-explanation-content-${questionIndex}`);
            
            explanationDiv.classList.remove('hidden');
            explanationContent.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span>ƒêang t·∫°o gi·∫£i th√≠ch...</span>
                </div>
            `;
            
            try {
                const explanation = await callGeminiAPI(question, userAnswer);
                explanationContent.innerHTML = `<p>${explanation}</p>`;
            } catch (error) {
                explanationContent.innerHTML = `
                    <p class="text-red-600">‚ùå Kh√¥ng th·ªÉ l·∫•y gi·∫£i th√≠ch t·ª´ AI.</p>
                    <p class="mt-2"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${question.correctAnswer} - ${question.answers[question.correctAnswer]}</p>
                `;
            }
        };
        
        // Modal ch·ªânh s·ª≠a c√¢u h·ªèi
        let editingQuestionId = null;
        window.editAdminQuestion = function(questionId) {
            editingQuestionId = questionId;
            const question = questions.find(q => q.id === questionId);
            if (!question) return;
            document.getElementById('edit-preview-img').src = question.image;
            document.getElementById('edit-question-content-input').value = question.content || '';
            document.getElementById('edit-answer-a').value = question.answers.A;
            document.getElementById('edit-answer-b').value = question.answers.B;
            document.getElementById('edit-answer-c').value = question.answers.C;
            document.getElementById('edit-answer-d').value = question.answers.D;
            document.getElementById('edit-correct-answer').value = question.correctAnswer;
            document.getElementById('edit-question-modal').classList.remove('hidden');
        };
        window.closeEditQuestionModal = function() {
            document.getElementById('edit-question-modal').classList.add('hidden');
            editingQuestionId = null;
        };

        // Trong h√†m displayAdminQuestions, th√™m n√∫t ph√≥ng to v√† s·ª≠a:
        questionsList.innerHTML = questionsToShow.map((question, index) => {
            // Find subject and question set names
            const subject = subjects.find(s => s.id === question.subjectId);
            const questionSet = questionSets.find(qs => qs.id === question.questionSetId);
            
            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-3">
                                <div class="relative">
                                    <img src="${question.image}" alt="Question ${index + 1}" class="w-20 h-20 object-cover rounded-lg cursor-pointer" onclick="openAdminImageModal('${question.image}')">
                                    <button onclick="openAdminImageModal('${question.image}')" class="absolute bottom-1 right-1 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">üîç</button>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">C√¢u ${index + 1}</h4>
                                    <p class="text-sm text-blue-600 font-medium">üìö ${subject?.name || 'Ch∆∞a r√µ m√¥n'} - üìã ${questionSet?.name || 'Ch∆∞a r√µ b·ªô ƒë·ªÅ'}</p>
                                    <p class="text-sm text-gray-600">${question.content || 'C√¢u h·ªèi t·ª´ h√¨nh ·∫£nh'}</p>
                                    <p class="text-sm text-green-600 font-medium">ƒê√°p √°n: ${question.correctAnswer}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>A. ${question.answers.A}</div>
                                <div>B. ${question.answers.B}</div>
                                <div>C. ${question.answers.C}</div>
                                <div>D. ${question.answers.D}</div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="editAdminQuestion('${question.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">‚úèÔ∏è S·ª≠a</button>
                            <button onclick="deleteAdminQuestion('${question.id}')" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">üóëÔ∏è X√≥a</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Th√™m modal ph√≥ng to ·∫£nh cho admin (d√πng l·∫°i modal c≈© nh∆∞ng id kh√°c)
        let adminCurrentZoom = 1, adminImgPosX = 0, adminImgPosY = 0, adminIsDragging = false, adminDragStartX = 0, adminDragStartY = 0;
        window.openAdminImageModal = function(imgSrc) {
            const modal = document.getElementById('admin-image-modal');
            const modalImg = document.getElementById('admin-modal-image');
            modalImg.src = imgSrc;
            adminCurrentZoom = 1; adminImgPosX = 0; adminImgPosY = 0;
            updateAdminImageTransform();
            modal.classList.remove('hidden');
            setupAdminImageInteraction();
        };
        function updateAdminImageTransform() {
            const modalImg = document.getElementById('admin-modal-image');
            modalImg.style.transform = `translate(${adminImgPosX}px, ${adminImgPosY}px) scale(${adminCurrentZoom})`;
        }
        function setupAdminImageInteraction() {
            const container = document.getElementById('admin-image-container');
            const modalImg = document.getElementById('admin-modal-image');
            container.onwheel = function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                adminCurrentZoom = Math.max(0.5, Math.min(5, adminCurrentZoom + delta));
                updateAdminImageTransform();
            };
            modalImg.onmousedown = function(e) {
                e.preventDefault();
                adminIsDragging = true;
                adminDragStartX = e.clientX - adminImgPosX;
                adminDragStartY = e.clientY - adminImgPosY;
                container.style.cursor = 'grabbing';
            };
            container.onmousemove = function(e) {
                if (!adminIsDragging) return;
                e.preventDefault();
                adminImgPosX = e.clientX - adminDragStartX;
                adminImgPosY = e.clientY - adminDragStartY;
                updateAdminImageTransform();
            };
            container.onmouseup = function() { adminIsDragging = false; container.style.cursor = 'move'; };
            container.onmouseleave = function() { adminIsDragging = false; container.style.cursor = 'move'; };
        }
        window.closeAdminImageModal = function() { document.getElementById('admin-image-modal').classList.add('hidden'); adminIsDragging = false; };
        window.adminZoomIn = function() { adminCurrentZoom = Math.min(adminCurrentZoom + 0.3, 5); updateAdminImageTransform(); };
        window.adminZoomOut = function() { adminCurrentZoom = Math.max(adminCurrentZoom - 0.3, 0.5); updateAdminImageTransform(); };
        window.adminResetZoom = function() { adminCurrentZoom = 1; adminImgPosX = 0; adminImgPosY = 0; updateAdminImageTransform(); };

        // ===================== ENHANCED AI QUIZ SYSTEM FUNCTIONS =====================
        
        // Enhanced global variables (avoid redeclaration)
        if (typeof adaptiveDifficulty === 'undefined') {
            window.adaptiveDifficulty = 'easy';
            window.userPerformanceData = {
                correctAnswers: 0,
                totalQuestions: 0,
                averageTime: 0,
                strongTopics: [],
                weakTopics: []
            };
        }

        // Enhanced Navigation Functions
        window.showUserDashboard = function() {
            hideAllSections();
            document.getElementById('user-dashboard').classList.remove('hidden');
            loadUserStats();
        };

        window.showAIChatbot = function() {
            hideAllUserSections();
            document.getElementById('ai-chatbot-section').classList.remove('hidden');
            initializeAIChatbot();
        };

        window.showStudyMode = function() {
            hideAllUserSections();
            document.getElementById('study-mode-section').classList.remove('hidden');
            loadFlashcards();
        };

        window.showQuizSelection = function() {
            hideAllUserSections();
            document.getElementById('quiz-selection-section').classList.remove('hidden');
            loadQuizSets();
        };

        window.backToMainDashboard = function() {
            hideAllUserSections();
            document.getElementById('main-dashboard').classList.remove('hidden');
        };

        function hideAllUserSections() {
            const sections = [
                'main-dashboard', 'ai-chatbot-section', 'study-mode-section', 
                'quiz-selection-section', 'quiz-interface', 'results-section'
            ];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }

        // AI Chatbot Functions
        function initializeAIChatbot() {
            const chatContainer = document.getElementById('ai-chat-container');
            if (!chatContainer.querySelector('.chat-ai')) {
                addChatMessage('Xin ch√†o! T√¥i l√† AI Assistant. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n h·ªçc t·∫≠p hi·ªáu qu·∫£ h∆°n. H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!', 'ai');
            }
        }

        window.sendAIMessage = function() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                generateAIResponse(message);
            }, 1000);
        };

        window.handleChatEnter = function(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        };

        window.askQuickQuestion = function(question) {
            document.getElementById('ai-chat-input').value = question;
            sendAIMessage();
        };

        function addChatMessage(message, sender) {
            const chatContainer = document.getElementById('ai-chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${sender}`;
            
            const avatar = sender === 'ai' ? 'ü§ñ' : 'üë§';
            const bgColor = sender === 'ai' ? 'bg-blue-50' : 'bg-green-50';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2 ${sender === 'user' ? 'flex-row-reverse' : ''}">
                    <div class="text-2xl">${avatar}</div>
                    <div class="p-3 rounded-lg ${bgColor} max-w-xs lg:max-w-md">
                        <p class="text-gray-800">${message}</p>
                        <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</p>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function generateAIResponse(userMessage) {
            try {
                // Add typing indicator
                addChatMessage('ƒêang suy nghƒ©...', 'ai');
                
                // Simulate AI processing
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Remove typing indicator
                const chatContainer = document.getElementById('ai-chat-container');
                chatContainer.removeChild(chatContainer.lastChild);
                
                // Generate contextual response
                let response = generateContextualResponse(userMessage);
                addChatMessage(response, 'ai');
                
            } catch (error) {
                console.error('Error generating AI response:', error);
                addChatMessage('Xin l·ªói, t√¥i g·∫∑p s·ª± c·ªë khi x·ª≠ l√Ω c√¢u h·ªèi c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'ai');
            }
        }

        function generateContextualResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('gi·∫£i th√≠ch')) {
                return 'T√¥i s·∫Ω gi·∫£i th√≠ch chi ti·∫øt cho b·∫°n. H√£y cung c·∫•p ch·ªß ƒë·ªÅ c·ª• th·ªÉ m√† b·∫°n mu·ªën t√¨m hi·ªÉu.';
            } else if (lowerMessage.includes('c√¢u h·ªèi')) {
                return 'T√¥i c√≥ th·ªÉ t·∫°o c√¢u h·ªèi luy·ªán t·∫≠p cho b·∫°n. B·∫°n mu·ªën luy·ªán t·∫≠p ch·ªß ƒë·ªÅ n√†o?';
            } else if (lowerMessage.includes('ƒëi·ªÉm y·∫øu')) {
                return 'D·ª±a tr√™n k·∫øt qu·∫£ quiz c·ªßa b·∫°n, t√¥i th·∫•y b·∫°n c·∫ßn c·∫£i thi·ªán ·ªü c√°c lƒ©nh v·ª±c: To√°n h·ªçc v√† Khoa h·ªçc. T√¥i khuy√™n b·∫°n n√™n luy·ªán t·∫≠p th√™m.';
            } else if (lowerMessage.includes('l·ªùi khuy√™n')) {
                return 'M·ªôt s·ªë l·ªùi khuy√™n h·ªçc t·∫≠p hi·ªáu qu·∫£: 1) L·∫≠p k·∫ø ho·∫°ch h·ªçc t·∫≠p r√µ r√†ng, 2) √în t·∫≠p ƒë·ªÅu ƒë·∫∑n, 3) S·ª≠ d·ª•ng ph∆∞∆°ng ph√°p flashcards, 4) Th·ª±c h√†nh nhi·ªÅu b√†i t·∫≠p.';
            } else {
                return 'C·∫£m ∆°n b·∫°n ƒë√£ h·ªèi! T√¥i hi·ªÉu c√¢u h·ªèi c·ªßa b·∫°n v√† s·∫Ω c·ªë g·∫Øng h·ªó tr·ª£ t·ªët nh·∫•t. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ b·∫•t k·ª≥ ch·ªß ƒë·ªÅ h·ªçc t·∫≠p n√†o.';
            }
        }

        // Flashcards Functions
        let flashcards = [];
        let currentFlashcardIndex = 0;
        let isFlashcardFlipped = false;

        function loadFlashcards() {
            flashcards = [
                { front: 'C√¥ng th·ª©c t√≠nh di·ªán t√≠ch h√¨nh tr√≤n?', back: 'S = œÄr¬≤' },
                { front: 'Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam?', back: 'H√† N·ªôi' },
                { front: 'Ai l√† t√°c gi·∫£ c·ªßa "Truy·ªán Ki·ªÅu"?', back: 'Nguy·ªÖn Du' }
            ];
            
            if (flashcards.length > 0) {
                displayCurrentFlashcard();
            }
        }

        function displayCurrentFlashcard() {
            if (flashcards.length === 0) return;
            
            const flashcard = flashcards[currentFlashcardIndex];
            document.getElementById('flashcard-front').textContent = flashcard.front;
            document.getElementById('flashcard-back').textContent = flashcard.back;
            
            // Reset flip state
            isFlashcardFlipped = false;
            document.getElementById('flashcard-front').classList.remove('hidden');
            document.getElementById('flashcard-back').classList.add('hidden');
        }

        window.flipFlashcard = function() {
            isFlashcardFlipped = !isFlashcardFlipped;
            document.getElementById('flashcard-front').classList.toggle('hidden');
            document.getElementById('flashcard-back').classList.toggle('hidden');
        };

        window.previousFlashcard = function() {
            if (flashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcards.length) % flashcards.length;
            displayCurrentFlashcard();
        };

        window.nextFlashcard = function() {
            if (flashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
            displayCurrentFlashcard();
        };

        window.generateNewFlashcards = function() {
            showNotification('ƒêang t·∫°o flashcards m·ªõi v·ªõi AI...', 'info');
            
            setTimeout(() => {
                flashcards = [
                    { front: 'ƒê·ªãnh lu·∫≠t Newton th·ª© nh·∫•t?', back: 'ƒê·ªãnh lu·∫≠t qu√°n t√≠nh: V·∫≠t s·∫Ω gi·ªØ nguy√™n tr·∫°ng th√°i ƒë·ª©ng y√™n ho·∫∑c chuy·ªÉn ƒë·ªông th·∫≥ng ƒë·ªÅu n·∫øu kh√¥ng c√≥ l·ª±c t√°c d·ª•ng' },
                    { front: 'C√¥ng th·ª©c h√≥a h·ªçc c·ªßa n∆∞·ªõc?', back: 'H‚ÇÇO' },
                    { front: 'NƒÉm Vi·ªát Nam ƒë·ªôc l·∫≠p?', back: '1945' }
                ];
                currentFlashcardIndex = 0;
                displayCurrentFlashcard();
                showNotification('ƒê√£ t·∫°o flashcards m·ªõi!', 'success');
            }, 2000);
        };

        window.generatePersonalizedPath = function() {
            showNotification('ƒêang t·∫°o l·ªô tr√¨nh h·ªçc t·∫≠p c√° nh√¢n...', 'info');
            setTimeout(() => {
                showNotification('ƒê√£ c·∫≠p nh·∫≠t l·ªô tr√¨nh h·ªçc t·∫≠p cho b·∫°n!', 'success');
            }, 3000);
        };

        // Enhanced Quiz Functions
        window.startQuiz = function(quizType) {
            hideAllUserSections();
            document.getElementById('quiz-interface').classList.remove('hidden');
            initializeQuiz(quizType);
        };

        function initializeQuiz(quizType) {
            currentQuestionIndex = 0;
            userPerformanceData.correctAnswers = 0;
            userPerformanceData.totalQuestions = 0;
            startTime = new Date();
            
            loadQuizQuestions(quizType);
            startQuizTimer();
            displayCurrentQuestion();
        }

        function loadQuizQuestions(quizType) {
            currentQuiz = {
                title: quizType || 'Quiz To√°n h·ªçc c∆° b·∫£n',
                questions: [
                    {
                        text: '2 + 2 = ?',
                        options: ['3', '4', '5', '6'],
                        correctAnswer: '4',
                        explanation: '2 + 2 = 4 l√† ph√©p t√≠nh c·ªông c∆° b·∫£n.',
                        difficulty: 'easy'
                    },
                    {
                        text: 'CƒÉn b·∫≠c hai c·ªßa 16 l√†?',
                        options: ['2', '4', '6', '8'],
                        correctAnswer: '4',
                        explanation: '‚àö16 = 4 v√¨ 4 √ó 4 = 16',
                        difficulty: 'medium'
                    },
                    {
                        text: 'ƒê·∫°o h√†m c·ªßa x¬≤ l√† g√¨?',
                        options: ['x', '2x', '2', 'x¬≤'],
                        correctAnswer: '2x',
                        explanation: 'ƒê·∫°o h√†m c·ªßa x¬≤ theo quy t·∫Øc l≈©y th·ª´a l√† 2x.',
                        difficulty: 'hard'
                    }
                ]
            };
            
            document.getElementById('quiz-title').textContent = currentQuiz.title;
            document.getElementById('total-questions').textContent = currentQuiz.questions.length;
        }

        function displayCurrentQuestion() {
            if (!currentQuiz || currentQuestionIndex >= currentQuiz.questions.length) {
                finishQuiz();
                return;
            }
            
            const question = currentQuiz.questions[currentQuestionIndex];
            
            // Update progress
            document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
            const progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
            document.getElementById('quiz-progress').style.width = progress + '%';
            
            // Update difficulty indicator
            updateDifficultyIndicator(question.difficulty);
            
            // Display question
            document.getElementById('question-text').textContent = question.text;
            
            // Display options
            const optionsContainer = document.getElementById('answer-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 transition-colors';
                optionDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 border-2 border-gray-300 rounded-full mr-3 flex items-center justify-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full hidden option-selected"></div>
                        </div>
                        <span class="text-gray-800">${option}</span>
                    </div>
                `;
                
                optionDiv.onclick = () => selectAnswer(option, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            // Reset UI elements
            document.getElementById('ai-hint-container').classList.add('hidden');
            document.getElementById('explanation-container').classList.add('hidden');
            document.getElementById('next-btn').disabled = true;
            document.getElementById('next-btn').classList.add('opacity-50');
        }

        function updateDifficultyIndicator(difficulty) {
            const indicators = document.querySelectorAll('#difficulty-indicator div');
            const text = document.getElementById('difficulty-text');
            
            indicators.forEach(ind => ind.className = 'w-3 h-3 rounded-full bg-gray-300');
            
            switch(difficulty) {
                case 'easy':
                    indicators[0].className = 'w-3 h-3 rounded-full bg-green-400';
                    text.textContent = 'D·ªÖ';
                    text.className = 'text-sm font-medium text-green-600';
                    break;
                case 'medium':
                    indicators[0].className = 'w-3 h-3 rounded-full bg-yellow-400';
                    indicators[1].className = 'w-3 h-3 rounded-full bg-yellow-400';
                    text.textContent = 'Trung b√¨nh';
                    text.className = 'text-sm font-medium text-yellow-600';
                    break;
                case 'hard':
                    indicators[0].className = 'w-3 h-3 rounded-full bg-red-400';
                    indicators[1].className = 'w-3 h-3 rounded-full bg-red-400';
                    indicators[2].className = 'w-3 h-3 rounded-full bg-red-400';
                    text.textContent = 'Kh√≥';
                    text.className = 'text-sm font-medium text-red-600';
                    break;
            }
        }

        let selectedAnswer = null;

        function selectAnswer(answer, optionElement) {
            // Remove previous selection
            document.querySelectorAll('.option-selected').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#answer-options > div').forEach(div => {
                div.classList.remove('border-blue-500', 'bg-blue-50');
                div.classList.add('border-gray-200');
            });
            
            // Mark current selection
            optionElement.classList.remove('border-gray-200');
            optionElement.classList.add('border-blue-500', 'bg-blue-50');
            optionElement.querySelector('.option-selected').classList.remove('hidden');
            
            selectedAnswer = answer;
            
            // Enable next button
            document.getElementById('next-btn').disabled = false;
            document.getElementById('next-btn').classList.remove('opacity-50');
        }

        window.getAIHint = function() {
            const question = currentQuiz.questions[currentQuestionIndex];
            const hintContainer = document.getElementById('ai-hint-container');
            const hintText = document.getElementById('ai-hint-text');
            
            const hint = generateHint(question);
            hintText.textContent = hint;
            hintContainer.classList.remove('hidden');
        };

        function generateHint(question) {
            if (question.text.includes('2 + 2')) {
                return 'H√£y nh·ªõ ph√©p c·ªông c∆° b·∫£n: c·ªông t·ª´ng ƒë∆°n v·ªã m·ªôt.';
            } else if (question.text.includes('cƒÉn b·∫≠c hai')) {
                return 'CƒÉn b·∫≠c hai c·ªßa m·ªôt s·ªë l√† s·ªë m√† khi nh√¢n v·ªõi ch√≠nh n√≥ s·∫Ω ra s·ªë ban ƒë·∫ßu.';
            } else if (question.text.includes('ƒë·∫°o h√†m')) {
                return 'S·ª≠ d·ª•ng quy t·∫Øc l≈©y th·ª´a: ƒë·∫°o h√†m c·ªßa x^n l√† n*x^(n-1).';
            }
            return 'H√£y ƒë·ªçc k·ªπ c√¢u h·ªèi v√† suy nghƒ© logic.';
        }

        window.skipQuestion = function() {
            selectedAnswer = null;
            nextQuestion();
        };

        window.nextQuestion = function() {
            if (selectedAnswer) {
                const question = currentQuiz.questions[currentQuestionIndex];
                if (selectedAnswer === question.correctAnswer) {
                    userPerformanceData.correctAnswers++;
                }
                userPerformanceData.totalQuestions++;
                
                showExplanation(question);
                document.getElementById('current-score').textContent = userPerformanceData.correctAnswers;
            }
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= currentQuiz.questions.length) {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('submit-btn').classList.remove('hidden');
            } else {
                setTimeout(() => {
                    displayCurrentQuestion();
                    selectedAnswer = null;
                }, 2000);
            }
        };

        function showExplanation(question) {
            const explanationContainer = document.getElementById('explanation-container');
            const explanationText = document.getElementById('explanation-text');
            
            explanationText.textContent = question.explanation;
            explanationContainer.classList.remove('hidden');
        }

        window.submitQuiz = function() {
            finishQuiz();
        };

        window.exitQuiz = function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t kh·ªèi quiz? Ti·∫øn tr√¨nh s·∫Ω b·ªã m·∫•t.')) {
                if (quizTimer) {
                    clearInterval(quizTimer);
                    quizTimer = null;
                }
                backToMainDashboard();
            }
        };

        function finishQuiz() {
            hideAllUserSections();
            document.getElementById('results-section').classList.remove('hidden');
            
            if (quizTimer) {
                clearInterval(quizTimer);
                quizTimer = null;
            }
            
            const endTime = new Date();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const accuracy = Math.round((userPerformanceData.correctAnswers / userPerformanceData.totalQuestions) * 100);
            
            document.getElementById('final-score').textContent = `${userPerformanceData.correctAnswers}/${userPerformanceData.totalQuestions}`;
            document.getElementById('time-taken').textContent = formatTime(totalTime);
            document.getElementById('accuracy-rate').textContent = accuracy + '%';
            
            // Update emoji and messages based on performance
            updateResultMessages(accuracy);
            generateAIAnalysis(accuracy);
        }

        function updateResultMessages(accuracy) {
            const emoji = document.getElementById('score-emoji');
            const message = document.getElementById('score-message');
            const timeMessage = document.getElementById('time-performance');
            const accuracyMessage = document.getElementById('accuracy-message');
            
            if (accuracy >= 90) {
                emoji.textContent = 'üéâ';
                message.textContent = 'Xu·∫•t s·∫Øc!';
                accuracyMessage.textContent = 'Tuy·ªát v·ªùi!';
            } else if (accuracy >= 70) {
                emoji.textContent = 'üëç';
                message.textContent = 'T·ªët l·∫Øm!';
                accuracyMessage.textContent = 'Kh√° t·ªët!';
            } else if (accuracy >= 50) {
                emoji.textContent = 'üòê';
                message.textContent = 'T·∫°m ·ªïn';
                accuracyMessage.textContent = 'C·∫ßn c·∫£i thi·ªán';
            } else {
                emoji.textContent = 'üòî';
                message.textContent = 'C·∫ßn h·ªçc th√™m';
                accuracyMessage.textContent = 'C·∫ßn luy·ªán t·∫≠p nhi·ªÅu h∆°n';
            }
            
            timeMessage.textContent = 'Ho√†n th√†nh';
        }

        function startQuizTimer() {
            let seconds = 0;
            quizTimer = setInterval(() => {
                seconds++;
                document.getElementById('quiz-timer').textContent = formatTime(seconds);
            }, 1000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function generateAIAnalysis(accuracy) {
            const analysisContainer = document.getElementById('ai-analysis-content');
            
            setTimeout(() => {
                let analysis = '';
                
                if (accuracy >= 80) {
                    analysis = `Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ƒë·∫°t ${accuracy}% ƒë·ªô ch√≠nh x√°c. B·∫°n c√≥ ki·∫øn th·ª©c v·ªØng v√†ng v√† k·ªπ nƒÉng gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ t·ªët. H√£y ti·∫øp t·ª•c duy tr√¨ phong ƒë·ªô n√†y!`;
                } else if (accuracy >= 60) {
                    analysis = `T·ªët! B·∫°n ƒë√£ ƒë·∫°t ${accuracy}% ƒë·ªô ch√≠nh x√°c. B·∫°n ƒëang tr√™n ƒë√∫ng h∆∞·ªõng, nh∆∞ng v·∫´n c√≥ th·ªÉ c·∫£i thi·ªán th√™m. T√¥i khuy√™n b·∫°n n√™n √¥n luy·ªán th√™m m·ªôt s·ªë ch·ªß ƒë·ªÅ.`;
                } else {
                    analysis = `B·∫°n c·∫ßn c·∫£i thi·ªán! ƒê·ªô ch√≠nh x√°c ${accuracy}% cho th·∫•y b·∫°n c·∫ßn h·ªçc th√™m. ƒê·ª´ng n·∫£n ch√≠, h√£y √¥n t·∫≠p k·ªπ l∆∞·ª°ng v√† th·ª≠ l·∫°i nh√©!`;
                }
                
                analysisContainer.innerHTML = `<p class="text-gray-700">${analysis}</p>`;
            }, 2000);
        }

        window.retakeQuiz = function() {
            if (currentQuiz) {
                initializeQuiz(currentQuiz.title);
            }
        };

        window.shareResults = function() {
            const accuracy = document.getElementById('accuracy-rate').textContent;
            const score = document.getElementById('final-score').textContent;
            const text = `T√¥i v·ª´a ho√†n th√†nh quiz v·ªõi k·∫øt qu·∫£: ${score} (${accuracy})! üéâ`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'K·∫øt qu·∫£ Quiz AI',
                    text: text,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text);
                showNotification('ƒê√£ sao ch√©p k·∫øt qu·∫£ v√†o clipboard!', 'success');
            }
        };

        // Enhanced Admin Functions for AI Tools
        window.processImageToQuestions = async function() {
            const fileInput = document.getElementById('image-upload-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Vui l√≤ng ch·ªçn h√¨nh ·∫£nh', 'warning');
                return;
            }
            
            showLoading('ƒêang x·ª≠ l√Ω h√¨nh ·∫£nh v·ªõi AI...');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const questions = [
                    {
                        text: 'D·ª±a v√†o h√¨nh ·∫£nh, ƒë√¢y l√† lo·∫°i bi·ªÉu ƒë·ªì g√¨?',
                        options: ['Bi·ªÉu ƒë·ªì c·ªôt', 'Bi·ªÉu ƒë·ªì tr√≤n', 'Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng', 'Bi·ªÉu ƒë·ªì ph√¢n t√°n'],
                        correctAnswer: 'Bi·ªÉu ƒë·ªì c·ªôt',
                        explanation: 'Bi·ªÉu ƒë·ªì c·ªôt ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ so s√°nh c√°c gi√° tr·ªã kh√°c nhau.'
                    },
                    {
                        text: 'Gi√° tr·ªã cao nh·∫•t trong bi·ªÉu ƒë·ªì l√† bao nhi√™u?',
                        options: ['50', '75', '100', '125'],
                        correctAnswer: '100',
                        explanation: 'Quan s√°t tr·ª•c Y, gi√° tr·ªã cao nh·∫•t l√† 100.'
                    }
                ];
                
                displayGeneratedQuestions(questions);
                hideLoading();
                showNotification('ƒê√£ t·∫°o ' + questions.length + ' c√¢u h·ªèi t·ª´ h√¨nh ·∫£nh!', 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('L·ªói x·ª≠ l√Ω h√¨nh ·∫£nh: ' + error.message, 'error');
            }
        };

        window.processDocumentToQuestions = async function() {
            const fileInput = document.getElementById('document-upload-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Vui l√≤ng ch·ªçn t√†i li·ªáu', 'warning');
                return;
            }
            
            showLoading('ƒêang ph√¢n t√≠ch t√†i li·ªáu v·ªõi AI...');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 4000));
                
                const questions = [
                    {
                        text: 'Theo t√†i li·ªáu, kh√°i ni·ªám ch√≠nh ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p l√† g√¨?',
                        options: ['Kh√°i ni·ªám A', 'Kh√°i ni·ªám B', 'Kh√°i ni·ªám C', 'Kh√°i ni·ªám D'],
                        correctAnswer: 'Kh√°i ni·ªám A',
                        explanation: 'Kh√°i ni·ªám A ƒë∆∞·ª£c nh·∫•n m·∫°nh xuy√™n su·ªët t√†i li·ªáu.'
                    }
                ];
                
                displayGeneratedQuestions(questions);
                hideLoading();
                showNotification('ƒê√£ t·∫°o ' + questions.length + ' c√¢u h·ªèi t·ª´ t√†i li·ªáu!', 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('L·ªói x·ª≠ l√Ω t√†i li·ªáu: ' + error.message, 'error');
            }
        };

        function displayGeneratedQuestions(questions) {
            const container = document.getElementById('generated-questions-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 border border-gray-200 rounded-lg';
                questionDiv.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-2">C√¢u ${index + 1}: ${question.text}</h4>
                    <div class="space-y-1 mb-2">
                        ${question.options.map((option, i) => `
                            <div class="text-sm ${option === question.correctAnswer ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                ${String.fromCharCode(65 + i)}. ${option}
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-sm text-gray-500 italic">${question.explanation}</p>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="editQuestion(${index})" class="btn-secondary text-sm">Ch·ªânh s·ª≠a</button>
                        <button onclick="saveQuestion(${index})" class="btn-primary text-sm">L∆∞u c√¢u h·ªèi</button>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        // Utility Functions
        function showLoading(message) {
            let overlay = document.getElementById('loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                document.body.appendChild(overlay);
            }
            
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-800">${message}</p>
                </div>
            `;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500', 
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function loadUserStats() {
            document.getElementById('total-attempts').textContent = '25';
            document.getElementById('average-score').textContent = '85%';
            document.getElementById('total-time').textContent = '12h 30m';
            document.getElementById('best-score').textContent = '95%';
        }

        function loadQuizSets() {
            const quizSetsContainer = document.getElementById('quiz-sets-list');
            if (!quizSetsContainer) return;
            
            const sampleQuizSets = [
                { title: 'To√°n h·ªçc c∆° b·∫£n', questions: 20, difficulty: 'D·ªÖ', icon: 'üî¢' },
                { title: 'VƒÉn h·ªçc Vi·ªát Nam', questions: 15, difficulty: 'Trung b√¨nh', icon: 'üìö' },
                { title: 'L·ªãch s·ª≠ th·∫ø gi·ªõi', questions: 25, difficulty: 'Kh√≥', icon: 'üåç' },
                { title: 'Khoa h·ªçc t·ª± nhi√™n', questions: 18, difficulty: 'Trung b√¨nh', icon: 'üß™' },
                { title: 'ƒê·ªãa l√Ω Vi·ªát Nam', questions: 12, difficulty: 'D·ªÖ', icon: 'üó∫Ô∏è' },
                { title: 'Ti·∫øng Anh c∆° b·∫£n', questions: 30, difficulty: 'D·ªÖ', icon: 'üá∫üá∏' }
            ];
            
            quizSetsContainer.innerHTML = '';
            sampleQuizSets.forEach(quiz => {
                const quizDiv = document.createElement('div');
                quizDiv.className = 'card cursor-pointer hover:shadow-lg transition-shadow';
                quizDiv.innerHTML = `
                    <div class="card-body text-center">
                        <div class="text-4xl mb-3">${quiz.icon}</div>
                        <h3 class="text-lg font-semibold mb-2">${quiz.title}</h3>
                        <p class="text-gray-600 mb-3">${quiz.questions} c√¢u h·ªèi ‚Ä¢ ${quiz.difficulty}</p>
                        <button onclick="startQuiz('${quiz.title}')" class="btn-primary w-full">
                            B·∫Øt ƒë·∫ßu
                        </button>
                    </div>
                `;
                quizSetsContainer.appendChild(quizDiv);
            });
        }

        // Initialize enhanced features when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced AI Quiz System loaded successfully!');
            
            // Auto-show user dashboard on load
            setTimeout(() => {
                if (document.getElementById('user-dashboard')) {
                    showUserDashboard();
                }
            }, 500);
        });

        // Additional utility functions
        function setupImagePreview() {
            console.log('Setting up image preview...');
            // Setup image preview functionality if needed
        }

        // Admin tab management function
        window.showAdminTab = function(tabName) {
            console.log('Showing admin tab:', tabName);
            
            // Hide all tabs
            const tabs = ['dashboard', 'ai-tools', 'subjects', 'questions', 'content', 'settings', 'users', 'analytics'];
            tabs.forEach(tab => {
                const tabElement = document.getElementById(`admin-tab-${tab}`);
                if (tabElement) {
                    tabElement.classList.add('hidden');
                }
                
                // Remove active class from tab buttons
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (tabBtn) {
                    tabBtn.classList.remove('active');
                    tabBtn.classList.add('tab-btn');
                }
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`admin-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            // Add active class to selected tab button
            const selectedBtn = document.getElementById(`tab-${tabName}`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
        };

        // Save API keys function
        window.saveAdminApiKeys = function() {
            const key1 = document.getElementById('admin-api-key-1-old')?.value || '';
            const key2 = document.getElementById('admin-api-key-2-old')?.value || '';
            
            const apiKeysData = { key1, key2 };
            
            try {
                localStorage.setItem('adminApiKeys', JSON.stringify(apiKeysData));
                alert('ƒê√£ l∆∞u API keys th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error saving API keys:', error);
                alert('L·ªói khi l∆∞u API keys!');
            }
        };

        // Delete question function
        window.deleteAdminQuestion = function(questionId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?')) return;
            
            try {
                // Remove from questions array
                questions = questions.filter(q => q.id !== questionId);
                displayAdminQuestions();
                loadAdminStats();
                alert('ƒê√£ x√≥a c√¢u h·ªèi!');
            } catch (error) {
                console.error('Error deleting question:', error);
                alert('L·ªói khi x√≥a c√¢u h·ªèi!');
            }
        };

        // Export system report function
        window.exportSystemReport = function() {
            alert('T√≠nh nƒÉng xu·∫•t b√°o c√°o ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        };

        // Make login functions globally accessible
        window.showAdminLogin = showAdminLogin;
        window.showUserLogin = showUserLogin;
        window.backToMain = backToMain;
        window.adminLogin = adminLogin;
        window.userLogin = userLogin;
        window.logout = logout;
        
        // Make API and admin functions globally accessible
        window.saveAdminApiKeys = saveAdminApiKeys;
        window.loadAdminApiKeys = loadAdminApiKeys;
        
        // Make user functions globally accessible
        window.showQuizSelection = window.showQuizSelection || function() {
            hideAllUserSections();
            const quizSection = document.getElementById('quiz-selection-section');
            if (quizSection) {
                quizSection.classList.remove('hidden');
                loadQuizSets();
            } else {
                alert('Quiz selection section not found!');
            }
        };
        
        window.showStudyMode = window.showStudyMode || function() {
            hideAllUserSections();
            const studySection = document.getElementById('study-mode-section');
            if (studySection) {
                studySection.classList.remove('hidden');
            } else {
                alert('Study mode section not found!');
            }
        };
        
        window.showAIChatbot = window.showAIChatbot || function() {
            hideAllUserSections();
            const aiSection = document.getElementById('ai-chatbot-section');
            if (aiSection) {
                aiSection.classList.remove('hidden');
            } else {
                alert('AI Chatbot section not found!');
            }
        };
        
        window.showUserProfile = window.showUserProfile || function() {
            alert('T√≠nh nƒÉng h·ªì s∆° ng∆∞·ªùi d√πng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        };
        
        function hideAllUserSections() {
            const sections = [
                'main-dashboard', 'ai-chatbot-section', 'study-mode-section', 
                'quiz-selection-section', 'quiz-interface', 'results-section'
            ];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }
        
        function loadQuizSets() {
            console.log('Loading quiz sets...');
            // For now, show sample data
            const quizContainer = document.getElementById('quiz-sets-list');
            if (quizContainer) {
                quizContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card hover:shadow-lg transition-shadow">
                            <div class="card-body">
                                <h3 class="text-xl font-bold text-blue-600 mb-3">üìö To√°n h·ªçc</h3>
                                <p class="text-gray-600 mb-4">25 c√¢u h·ªèi ‚Ä¢ C·∫•p ƒë·ªô c∆° b·∫£n</p>
                                <button onclick="alert('T√≠nh nƒÉng l√†m b√†i ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!')" class="btn-primary w-full">
                                    B·∫Øt ƒë·∫ßu l√†m b√†i
                                </button>
                            </div>
                        </div>
                        <div class="card hover:shadow-lg transition-shadow">
                            <div class="card-body">
                                <h3 class="text-xl font-bold text-green-600 mb-3">‚öóÔ∏è H√≥a h·ªçc</h3>
                                <p class="text-gray-600 mb-4">30 c√¢u h·ªèi ‚Ä¢ C·∫•p ƒë·ªô trung b√¨nh</p>
                                <button onclick="alert('T√≠nh nƒÉng l√†m b√†i ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!')" class="btn-primary w-full">
                                    B·∫Øt ƒë·∫ßu l√†m b√†i
                                </button>
                            </div>
                        </div>
                        <div class="card hover:shadow-lg transition-shadow">
                            <div class="card-body">
                                <h3 class="text-xl font-bold text-purple-600 mb-3">üî¨ V·∫≠t l√Ω</h3>
                                <p class="text-gray-600 mb-4">20 c√¢u h·ªèi ‚Ä¢ C·∫•p ƒë·ªô n√¢ng cao</p>
                                <button onclick="alert('T√≠nh nƒÉng l√†m b√†i ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!')" class="btn-primary w-full">
                                    B·∫Øt ƒë·∫ßu l√†m b√†i
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // AI Functions for Admin - Enhanced Version
        function handleAIImageUpload(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            // Check file sizes
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File "${file.name}" qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 10MB.`);
                    return;
                }
            }
            
            window.currentAIImages = [];
            const preview = document.getElementById('ai-image-preview');
            const container = document.getElementById('ai-images-container');
            
            container.innerHTML = '';
            
            let loadedCount = 0;
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.currentAIImages.push({
                        data: e.target.result,
                        name: file.name,
                        type: file.type
                    });
                    
                    // Create preview element
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'border rounded-lg p-3';
                    imageDiv.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${e.target.result}" alt="${file.name}" class="w-20 h-20 object-cover rounded">
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${file.name}</p>
                                <p class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                            <button onclick="removeAIImage(${index})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(imageDiv);
                    
                    loadedCount++;
                    if (loadedCount === files.length) {
                        preview.classList.remove('hidden');
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        function removeAIImage(index) {
            if (window.currentAIImages) {
                window.currentAIImages.splice(index, 1);
                // Refresh the display
                const input = document.getElementById('ai-image-input');
                input.value = '';
                
                if (window.currentAIImages.length === 0) {
                    document.getElementById('ai-image-preview').classList.add('hidden');
                } else {
                    // Re-render remaining images
                    const container = document.getElementById('ai-images-container');
                    container.innerHTML = '';
                    window.currentAIImages.forEach((img, idx) => {
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'border rounded-lg p-3';
                        imageDiv.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <img src="${img.data}" alt="${img.name}" class="w-20 h-20 object-cover rounded">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${img.name}</p>
                                </div>
                                <button onclick="removeAIImage(${idx})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(imageDiv);
                    });
                }
            }
        }
        
        async function processMultipleImagesWithAI() {
            if (!window.currentAIImages || window.currentAIImages.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh!');
                return;
            }
            
            // Check if API keys are available
            const savedKeys = localStorage.getItem('gemini-api-keys');
            if (!savedKeys) {
                alert('‚ùå Vui l√≤ng c·∫•u h√¨nh API keys trong ph·∫ßn Settings tr∆∞·ªõc!');
                return;
            }
            
            const keys = JSON.parse(savedKeys);
            if (!keys.key1 && !keys.key2) {
                alert('‚ùå Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt API key trong Settings!');
                return;
            }
            
            // Show processing state
            const processBtn = document.querySelector('.ai-processing');
            const normalText = document.querySelector('.normal-text');
            if (processBtn) processBtn.classList.remove('hidden');
            if (normalText) normalText.classList.add('hidden');
            
            try {
                console.log('ü§ñ Starting AI image processing...');
                const allGeneratedQuestions = [];
                
                for (let i = 0; i < window.currentAIImages.length; i++) {
                    const image = window.currentAIImages[i];
                    console.log(`Processing image ${i + 1}/${window.currentAIImages.length}: ${image.name}`);
                    
                    // Call real Gemini API
                    const aiResponse = await callGeminiVisionAPI(image.data, keys);
                    if (aiResponse) {
                        allGeneratedQuestions.push(aiResponse);
                        console.log(`‚úÖ Successfully processed image ${i + 1}`);
                    } else {
                        console.error(`‚ùå Failed to process image ${i + 1}`);
                        // Add fallback response
                        allGeneratedQuestions.push({
                            question: `L·ªói: Kh√¥ng th·ªÉ x·ª≠ l√Ω h√¨nh ·∫£nh ${image.name}. Vui l√≤ng th·ª≠ l·∫°i.`,
                            answers: { A: "Error", B: "Error", C: "Error", D: "Error" },
                            correctAnswer: "A",
                            explanation: "C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω h√¨nh ·∫£nh n√†y."
                        });
                    }
                    
                    // Add delay between requests to avoid rate limiting
                    if (i < window.currentAIImages.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                displayMultipleAIGeneratedQuestions(allGeneratedQuestions);
                console.log('üéâ AI processing complete!');
                
            } catch (error) {
                console.error('‚ùå AI processing error:', error);
                alert('L·ªói khi x·ª≠ l√Ω b·∫±ng AI. Chi ti·∫øt l·ªói: ' + error.message);
            } finally {
                // Reset button state
                if (processBtn) processBtn.classList.add('hidden');
                if (normalText) normalText.classList.remove('hidden');
            }
        }
        
        async function callGeminiVisionAPI(imageDataUrl, keys) {
            // Extract base64 data from data URL
            const base64Data = imageDataUrl.split(',')[1];
            const mimeType = imageDataUrl.split(';')[0].split(':')[1];
            
            // Prompt to extract quiz questions from image
            const prompt = `B·∫°n l√† m·ªôt chuy√™n gia t·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám t·ª´ h√¨nh ·∫£nh. 
            
Nhi·ªám v·ª•: Ph√¢n t√≠ch h√¨nh ·∫£nh n√†y v√† tr√≠ch xu·∫•t CH√çNH X√ÅC n·ªôi dung c√¢u h·ªèi tr·∫Øc nghi·ªám c√≥ trong ·∫£nh.

H∆∞·ªõng d·∫´n:
1. ƒê·ªçc CH√çNH X√ÅC vƒÉn b·∫£n trong h√¨nh ·∫£nh
2. N·∫øu c√≥ c√¢u h·ªèi v√† ƒë√°p √°n: tr√≠ch xu·∫•t y nguy√™n
3. N·∫øu ch·ªâ c√≥ n·ªôi dung: t·∫°o c√¢u h·ªèi ph√π h·ª£p
4. Gi·ªØ nguy√™n ng√¥n ng·ªØ g·ªëc (Ti·∫øng Vi·ªát, English, Êó•Êú¨Ë™û, etc.)

Tr·∫£ v·ªÅ k·∫øt qu·∫£ theo ƒë·ªãnh d·∫°ng JSON sau:
{
  "question": "C√¢u h·ªèi ch√≠nh x√°c t·ª´ h√¨nh ·∫£nh",
  "answers": {
    "A": "ƒê√°p √°n A",
    "B": "ƒê√°p √°n B", 
    "C": "ƒê√°p √°n C",
    "D": "ƒê√°p √°n D"
  },
  "correctAnswer": "A",
  "explanation": "Gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n n√†y ƒë√∫ng"
}

QUAN TR·ªåNG: 
- ƒê·ªçc ch√≠nh x√°c vƒÉn b·∫£n, kh√¥ng ƒë∆∞·ª£c t·ª± b·ªãa
- Gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng v√† ng√¥n ng·ªØ g·ªëc
- N·∫øu kh√¥ng ƒë·ªçc ƒë∆∞·ª£c, h√£y th·∫≠t th√† n√≥i "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c h√¨nh ·∫£nh"`;

            const requestBody = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    temperature: 0.1,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };
            
            // Try both API keys
            const apiKeys = [keys.key1, keys.key2].filter(key => key);
            
            for (const apiKey of apiKeys) {
                try {
                    console.log('üîë Trying API key...');
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Gemini API response received');
                        
                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            const content = data.candidates[0].content.parts[0].text;
                            console.log('üìù Raw AI response:', content);
                            
                            // Try to parse JSON response
                            try {
                                const jsonMatch = content.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    const parsedResponse = JSON.parse(jsonMatch[0]);
                                    console.log('‚úÖ Parsed AI response:', parsedResponse);
                                    return parsedResponse;
                                } else {
                                    throw new Error('No JSON found in response');
                                }
                            } catch (parseError) {
                                console.error('‚ùå JSON parse error:', parseError);
                                // Fallback: create response from raw text
                                return {
                                    question: content.substring(0, 200) + '...',
                                    answers: {
                                        A: "ƒê√°p √°n A (t·ª´ AI)",
                                        B: "ƒê√°p √°n B (t·ª´ AI)",
                                        C: "ƒê√°p √°n C (t·ª´ AI)", 
                                        D: "ƒê√°p √°n D (t·ª´ AI)"
                                    },
                                    correctAnswer: "A",
                                    explanation: "AI ƒë√£ ph√¢n t√≠ch h√¨nh ·∫£nh nh∆∞ng c·∫ßn ch·ªânh s·ª≠a th·ªß c√¥ng."
                                };
                            }
                        }
                    } else {
                        console.error('‚ùå API call failed:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('‚ùå API request error:', error);
                }
            }
            
            return null; // All API keys failed
        }
        
        function generateSmartAIResponse(questionType, imageName, questionIndex) {
            const responses = {
                japanese: {
                    question: `C√¢u h·ªèi ti·∫øng Nh·∫≠t s·ªë ${questionIndex} ƒë∆∞·ª£c t·∫°o t·ª´ h√¨nh ·∫£nh ${imageName}. Êó•Êú¨Ë™û„ÅÆË≥™Âïè„Åß„Åô„ÄÇ`,
                    answers: {
                        A: "Êó•Êú¨ (Nh·∫≠t B·∫£n)",
                        B: "‰∏≠ÂõΩ (Trung Qu·ªëc)", 
                        C: "ÈüìÂõΩ (H√†n Qu·ªëc)",
                        D: "„Ç¢„É°„É™„Ç´ (M·ªπ)"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ ph√¢n t√≠ch n·ªôi dung ti·∫øng Nh·∫≠t trong h√¨nh ·∫£nh v√† t·∫°o ra c√¢u h·ªèi ph√π h·ª£p v·ªõi ng·ªØ c·∫£nh Nh·∫≠t B·∫£n."
                },
                math: {
                    question: `B√†i to√°n s·ªë ${questionIndex} t·ª´ h√¨nh ·∫£nh: T√≠nh gi√° tr·ªã c·ªßa bi·ªÉu th·ª©c ƒë∆∞·ª£c hi·ªÉn th·ªã trong h√¨nh.`,
                    answers: {
                        A: "42",
                        B: "84", 
                        C: "126",
                        D: "168"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ ph√¢n t√≠ch c√¥ng th·ª©c to√°n h·ªçc trong h√¨nh ·∫£nh v√† t√≠nh to√°n k·∫øt qu·∫£ ch√≠nh x√°c."
                },
                science: {
                    question: `C√¢u h·ªèi khoa h·ªçc s·ªë ${questionIndex}: D·ª±a v√†o h√¨nh ·∫£nh, hi·ªán t∆∞·ª£ng n√†o ƒë∆∞·ª£c m√¥ t·∫£?`,
                    answers: {
                        A: "Quang h·ª£p",
                        B: "H√¥ h·∫•p t·∫ø b√†o", 
                        C: "Ph√¢n gi·∫£i",
                        D: "L√™n men"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ nh·∫≠n di·ªán c√°c y·∫øu t·ªë khoa h·ªçc trong h√¨nh ·∫£nh v√† t·∫°o c√¢u h·ªèi ph√π h·ª£p."
                },
                history: {
                    question: `C√¢u h·ªèi l·ªãch s·ª≠ s·ªë ${questionIndex}: S·ª± ki·ªán n√†o ƒë∆∞·ª£c th·ªÉ hi·ªán trong h√¨nh ·∫£nh?`,
                    answers: {
                        A: "C√°ch m·∫°ng Th√°ng T√°m 1945",
                        B: "Chi·∫øn tranh Vi·ªát Nam", 
                        C: "Kh√°ng chi·∫øn ch·ªëng Ph√°p",
                        D: "Th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ ph√¢n t√≠ch b·ªëi c·∫£nh l·ªãch s·ª≠ trong h√¨nh ·∫£nh v√† t·∫°o c√¢u h·ªèi ph√π h·ª£p."
                },
                language: {
                    question: `C√¢u h·ªèi ngo·∫°i ng·ªØ s·ªë ${questionIndex}: What is shown in the image?`,
                    answers: {
                        A: "A beautiful landscape",
                        B: "A busy city street", 
                        C: "An academic question",
                        D: "A cultural scene"
                    },
                    correctAnswer: "C",
                    explanation: "AI analyzed the educational content in the image and created an appropriate language question."
                },
                text: {
                    question: `C√¢u h·ªèi s·ªë ${questionIndex} ƒë∆∞·ª£c AI t·∫°o t·ª´ n·ªôi dung h√¨nh ·∫£nh ${imageName}.`,
                    answers: {
                        A: "ƒê√°p √°n A ƒë∆∞·ª£c AI ph√¢n t√≠ch t·ª´ h√¨nh ·∫£nh",
                        B: "ƒê√°p √°n B d·ª±a tr√™n n·ªôi dung h√¨nh ·∫£nh", 
                        C: "ƒê√°p √°n C t·ª´ ph√¢n t√≠ch AI",
                        D: "ƒê√°p √°n D do AI g·ª£i √Ω"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ ph√¢n t√≠ch n·ªôi dung h√¨nh ·∫£nh v√† t·∫°o ra c√¢u h·ªèi ph√π h·ª£p v·ªõi ch·ªß ƒë·ªÅ ƒë∆∞·ª£c hi·ªÉn th·ªã."
                }
            };
            
            return responses[questionType] || responses.text;
        }
        
        function displayMultipleAIGeneratedQuestions(allQuestions) {
            const resultDiv = document.getElementById('ai-processing-result');
            const contentDiv = document.getElementById('ai-generated-content');
            
            if (!resultDiv || !contentDiv) {
                alert('UI elements not found for AI processing result!');
                return;
            }
            
            let questionsHTML = `<div class="space-y-6">`;
            
            allQuestions.forEach((aiResponse, index) => {
                questionsHTML += `
                    <div class="border rounded-lg p-4 bg-white">
                        <h6 class="font-bold text-blue-600 mb-3">C√¢u h·ªèi ${index + 1}:</h6>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung c√¢u h·ªèi:</label>
                                <textarea id="ai-question-content-${index}" class="w-full p-3 border rounded-lg" rows="2">${aiResponse.question}</textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n A:</label>
                                    <input type="text" id="ai-answer-a-${index}" value="${aiResponse.answers.A}" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n B:</label>
                                    <input type="text" id="ai-answer-b-${index}" value="${aiResponse.answers.B}" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n C:</label>
                                    <input type="text" id="ai-answer-c-${index}" value="${aiResponse.answers.C}" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n D:</label>
                                    <input type="text" id="ai-answer-d-${index}" value="${aiResponse.answers.D}" class="w-full p-2 border rounded">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                                    <select id="ai-correct-answer-${index}" class="w-full p-2 border rounded">
                                        <option value="A" ${aiResponse.correctAnswer === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${aiResponse.correctAnswer === 'B' ? 'selected' : ''}>B</option>
                                        <option value="C" ${aiResponse.correctAnswer === 'C' ? 'selected' : ''}>C</option>
                                        <option value="D" ${aiResponse.correctAnswer === 'D' ? 'selected' : ''}>D</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="acceptSingleAIQuestion(${index})" class="btn-success w-full">
                                        <i class="fas fa-check mr-2"></i>Th√™m c√¢u h·ªèi n√†y
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gi·∫£i th√≠ch:</label>
                                <textarea id="ai-explanation-${index}" class="w-full p-3 border rounded-lg" rows="2">${aiResponse.explanation}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            questionsHTML += `</div>
                <div class="mt-6 flex space-x-3">
                    <button onclick="acceptAllAIQuestions()" class="btn-success">
                        <i class="fas fa-check-double mr-2"></i>Th√™m t·∫•t c·∫£ (${allQuestions.length} c√¢u)
                    </button>
                    <button onclick="regenerateAIQuestion()" class="btn-warning">
                        <i class="fas fa-redo mr-2"></i>T·∫°o l·∫°i
                    </button>
                    <button onclick="cancelAIQuestion()" class="btn-danger">
                        <i class="fas fa-times mr-2"></i>H·ªßy
                    </button>
                </div>
            `;
            
            contentDiv.innerHTML = questionsHTML;
            resultDiv.classList.remove('hidden');
            window.currentAIQuestions = allQuestions;
        }
        
        async function processImageWithAI() {
            if (!window.currentAIImage) {
                alert('Vui l√≤ng ch·ªçn h√¨nh ·∫£nh tr∆∞·ªõc!');
                return;
            }
            
            // Check if API keys are available
            const savedKeys = localStorage.getItem('gemini-api-keys');
            if (!savedKeys) {
                alert('Vui l√≤ng c·∫•u h√¨nh API keys trong ph·∫ßn Settings tr∆∞·ªõc!');
                return;
            }
            
            const keys = JSON.parse(savedKeys);
            if (!keys.key1 && !keys.key2) {
                alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt API key trong Settings!');
                return;
            }
            
            // Show processing state
            const processBtn = document.querySelector('.ai-processing');
            const normalText = document.querySelector('.normal-text');
            if (processBtn) processBtn.classList.remove('hidden');
            if (normalText) normalText.classList.add('hidden');
            
            try {
                // Simulate AI processing (you can replace this with actual Gemini API call)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate sample AI response
                const aiResponse = {
                    question: "D·ª±a v√†o h√¨nh ·∫£nh, ƒë√¢y l√† c√¢u h·ªèi ƒë∆∞·ª£c AI t·∫°o t·ª± ƒë·ªông t·ª´ n·ªôi dung h√¨nh ·∫£nh.",
                    answers: {
                        A: "ƒê√°p √°n A ƒë∆∞·ª£c AI ph√¢n t√≠ch",
                        B: "ƒê√°p √°n B ƒë∆∞·ª£c AI t·∫°o ra", 
                        C: "ƒê√°p √°n C t·ª´ AI",
                        D: "ƒê√°p √°n D do AI g·ª£i √Ω"
                    },
                    correctAnswer: "A",
                    explanation: "AI ƒë√£ ph√¢n t√≠ch h√¨nh ·∫£nh v√† t·∫°o ra c√¢u h·ªèi ph√π h·ª£p v·ªõi n·ªôi dung. ƒê√°p √°n ƒë√∫ng ƒë∆∞·ª£c x√°c ƒë·ªãnh d·ª±a tr√™n ph√¢n t√≠ch th√¥ng minh."
                };
                
                displayAIGeneratedQuestion(aiResponse);
                
            } catch (error) {
                console.error('AI processing error:', error);
                alert('L·ªói khi x·ª≠ l√Ω b·∫±ng AI. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                // Reset button state
                if (processBtn) processBtn.classList.add('hidden');
                if (normalText) normalText.classList.remove('hidden');
            }
        }
        
        function displayAIGeneratedQuestion(aiResponse) {
            const resultDiv = document.getElementById('ai-processing-result');
            const contentDiv = document.getElementById('ai-generated-content');
            
            if (!resultDiv || !contentDiv) {
                alert('UI elements not found for AI processing result!');
                return;
            }
            
            contentDiv.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C√¢u h·ªèi ƒë∆∞·ª£c AI t·∫°o:</label>
                        <textarea id="ai-question-content" class="w-full p-3 border rounded-lg" rows="3">${aiResponse.question}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n A:</label>
                            <input type="text" id="ai-answer-a" value="${aiResponse.answers.A}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n B:</label>
                            <input type="text" id="ai-answer-b" value="${aiResponse.answers.B}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n C:</label>
                            <input type="text" id="ai-answer-c" value="${aiResponse.answers.C}" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒê√°p √°n D:</label>
                            <input type="text" id="ai-answer-d" value="${aiResponse.answers.D}" class="w-full p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ƒê√°p √°n ƒë√∫ng:</label>
                        <select id="ai-correct-answer" class="w-full p-2 border rounded">
                            <option value="A" ${aiResponse.correctAnswer === 'A' ? 'selected' : ''}>A</option>
                            <option value="B" ${aiResponse.correctAnswer === 'B' ? 'selected' : ''}>B</option>
                            <option value="C" ${aiResponse.correctAnswer === 'C' ? 'selected' : ''}>C</option>
                            <option value="D" ${aiResponse.correctAnswer === 'D' ? 'selected' : ''}>D</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gi·∫£i th√≠ch c·ªßa AI:</label>
                        <textarea id="ai-explanation" class="w-full p-3 border rounded-lg" rows="3">${aiResponse.explanation}</textarea>
                    </div>
                </div>
            `;
            
            resultDiv.classList.remove('hidden');
            window.currentAIQuestion = aiResponse;
        }
        
        function acceptAIQuestion() {
            if (!window.currentAIQuestion) {
                alert('Kh√¥ng c√≥ c√¢u h·ªèi AI n√†o ƒë·ªÉ ch·∫•p nh·∫≠n!');
                return;
            }
            
            // Get updated values from form
            const questionData = {
                id: Date.now().toString(),
                content: document.getElementById('ai-question-content').value,
                image: window.currentAIImage,
                answers: {
                    A: document.getElementById('ai-answer-a').value,
                    B: document.getElementById('ai-answer-b').value,
                    C: document.getElementById('ai-answer-c').value,
                    D: document.getElementById('ai-answer-d').value
                },
                correctAnswer: document.getElementById('ai-correct-answer').value,
                explanation: document.getElementById('ai-explanation').value,
                createdAt: new Date(),
                createdBy: currentUser,
                isAIGenerated: true
            };
            
            // Add to questions array
            questions.push(questionData);
            
            // Save to localStorage
            localStorage.setItem('quiz-questions', JSON.stringify(questions));
            
            // Refresh admin questions display
            displayAdminQuestions();
            loadAdminStats();
            
            // Clear AI form
            cancelAIQuestion();
            
            alert('‚úÖ ƒê√£ th√™m c√¢u h·ªèi AI th√†nh c√¥ng!');
        }
        
        function regenerateAIQuestion() {
            // Regenerate with current images
            if (window.currentAIImages && window.currentAIImages.length > 0) {
                processMultipleImagesWithAI();
            } else {
                processImageWithAI();
            }
        }
        
        function acceptSingleAIQuestion(index) {
            if (!window.currentAIQuestions || !window.currentAIQuestions[index]) {
                alert('Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi ƒë·ªÉ th√™m!');
                return;
            }
            
            // Get updated values from form
            const questionData = {
                id: Date.now().toString() + '_' + index,
                content: document.getElementById(`ai-question-content-${index}`).value,
                image: window.currentAIImages ? window.currentAIImages[index]?.data : window.currentAIImage,
                answers: {
                    A: document.getElementById(`ai-answer-a-${index}`).value,
                    B: document.getElementById(`ai-answer-b-${index}`).value,
                    C: document.getElementById(`ai-answer-c-${index}`).value,
                    D: document.getElementById(`ai-answer-d-${index}`).value
                },
                correctAnswer: document.getElementById(`ai-correct-answer-${index}`).value,
                explanation: document.getElementById(`ai-explanation-${index}`).value,
                createdAt: new Date(),
                createdBy: currentUser,
                isAIGenerated: true
            };
            
            // Add to questions array
            questions.push(questionData);
            
            // Save to localStorage
            localStorage.setItem('quiz-questions', JSON.stringify(questions));
            
            // Refresh admin questions display
            displayAdminQuestions();
            loadAdminStats();
            
            alert(`‚úÖ ƒê√£ th√™m c√¢u h·ªèi ${index + 1} th√†nh c√¥ng!`);
        }
        
        function acceptAllAIQuestions() {
            if (!window.currentAIQuestions || window.currentAIQuestions.length === 0) {
                alert('Kh√¥ng c√≥ c√¢u h·ªèi AI n√†o ƒë·ªÉ th√™m!');
                return;
            }
            
            let addedCount = 0;
            
            for (let i = 0; i < window.currentAIQuestions.length; i++) {
                try {
                    const questionData = {
                        id: Date.now().toString() + '_' + i,
                        content: document.getElementById(`ai-question-content-${i}`).value,
                        image: window.currentAIImages ? window.currentAIImages[i]?.data : window.currentAIImage,
                        answers: {
                            A: document.getElementById(`ai-answer-a-${i}`).value,
                            B: document.getElementById(`ai-answer-b-${i}`).value,
                            C: document.getElementById(`ai-answer-c-${i}`).value,
                            D: document.getElementById(`ai-answer-d-${i}`).value
                        },
                        correctAnswer: document.getElementById(`ai-correct-answer-${i}`).value,
                        explanation: document.getElementById(`ai-explanation-${i}`).value,
                        createdAt: new Date(),
                        createdBy: currentUser,
                        isAIGenerated: true
                    };
                    
                    questions.push(questionData);
                    addedCount++;
                } catch (error) {
                    console.error(`Error adding question ${i + 1}:`, error);
                }
            }
            
            // Save to localStorage
            localStorage.setItem('quiz-questions', JSON.stringify(questions));
            
            // Refresh admin questions display
            displayAdminQuestions();
            loadAdminStats();
            
            // Clear AI form
            cancelAIQuestion();
            
            alert(`‚úÖ ƒê√£ th√™m th√†nh c√¥ng ${addedCount}/${window.currentAIQuestions.length} c√¢u h·ªèi AI!`);
        }
        
        function cancelAIQuestion() {
            const resultDiv = document.getElementById('ai-processing-result');
            const previewDiv = document.getElementById('ai-image-preview');
            const inputElement = document.getElementById('ai-image-input');
            
            if (resultDiv) resultDiv.classList.add('hidden');
            if (previewDiv) previewDiv.classList.add('hidden');
            if (inputElement) inputElement.value = '';
            
            window.currentAIImage = null;
            window.currentAIImages = null;
            window.currentAIQuestion = null;
            window.currentAIQuestions = null;
        }
        
        function handleDocumentUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
                alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 50MB.');
                return;
            }
            
            alert('T√≠nh nƒÉng x·ª≠ l√Ω t√†i li·ªáu AI ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn! Hi·ªán t·∫°i ch·ªâ h·ªó tr·ª£ t·∫°o c√¢u h·ªèi t·ª´ h√¨nh ·∫£nh.');
        }

        // Quick Add Question Function
        function quickAddQuestion(event) {
            event.preventDefault();
            
            console.log('üöÄ Quick Add Question triggered');
            
            // Get form values
            const subject = document.getElementById('quick-subject').value;
            const difficulty = document.getElementById('quick-difficulty').value;
            const questionContent = document.getElementById('quick-question').value.trim();
            const answerA = document.getElementById('quick-answer-a').value.trim();
            const answerB = document.getElementById('quick-answer-b').value.trim();
            const answerC = document.getElementById('quick-answer-c').value.trim();
            const answerD = document.getElementById('quick-answer-d').value.trim();
            const correctAnswer = document.getElementById('quick-correct-answer').value;
            
            // Validate inputs
            if (!questionContent || !answerA || !answerB || !answerC || !answerD || !correctAnswer) {
                alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ th√¥ng tin!');
                return;
            }
            
            // Load existing questions
            let questions = JSON.parse(localStorage.getItem('quiz-questions') || '[]');
            
            // Create question object
            const questionData = {
                id: Date.now().toString(),
                subject: subject,
                set: currentActiveQuestionSet || 'B·ªô 1',
                content: questionContent,
                answers: {
                    A: answerA,
                    B: answerB,
                    C: answerC,
                    D: answerD
                },
                correctAnswer: correctAnswer,
                explanation: `ƒê√°p √°n ƒë√∫ng l√† ${correctAnswer}`,
                difficulty: difficulty,
                createdAt: new Date(),
                createdBy: currentUser || 'Admin',
                isAIGenerated: false
            };
            
            // Add to questions array
            questions.push(questionData);
            
            // Save to localStorage
            localStorage.setItem('quiz-questions', JSON.stringify(questions));
            
            console.log('‚úÖ Quick question added:', questionData);
            
            // Reset form (keep subject and difficulty)
            document.getElementById('quick-question').value = '';
            document.getElementById('quick-answer-a').value = '';
            document.getElementById('quick-answer-b').value = '';
            document.getElementById('quick-answer-c').value = '';
            document.getElementById('quick-answer-d').value = '';
            document.getElementById('quick-correct-answer').value = '';
            
            // Refresh display
            displayAdminQuestions();
            loadAdminStats();
            
            // Show success message
            alert('‚úÖ ƒê√£ th√™m c√¢u h·ªèi th√†nh c√¥ng!');
            
            // Focus back to question input for quick adding more
            document.getElementById('quick-question').focus();
        }
        
        // Expose AI functions globally
        window.handleAIImageUpload = handleAIImageUpload;
        window.removeAIImage = removeAIImage;
        window.processImageWithAI = processImageWithAI;
        window.processMultipleImagesWithAI = processMultipleImagesWithAI;
        window.acceptAIQuestion = acceptAIQuestion;
        window.acceptSingleAIQuestion = acceptSingleAIQuestion;
        window.acceptAllAIQuestions = acceptAllAIQuestions;
        window.regenerateAIQuestion = regenerateAIQuestion;
        window.cancelAIQuestion = cancelAIQuestion;
        window.handleDocumentUpload = handleDocumentUpload;
        
        // Expose subject functions globally
        window.addSubject = addSubject;
        window.processImageWithAI = processImageWithAI;
        window.acceptAIQuestion = acceptAIQuestion;
        window.regenerateAIQuestion = regenerateAIQuestion;
        window.cancelAIQuestion = cancelAIQuestion;
        window.handleDocumentUpload = handleDocumentUpload;

    </script>
</body>
</html> 